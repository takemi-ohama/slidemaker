# Phase 5: CLIインターフェース実装計画

**作成日**: 2025-12-23
**対象フェーズ**: Phase 5
**推定工数**: 1-2週
**実装規模**: 小〜中規模（約400-600行）

---

## 📋 概要

Phase 5では、コマンドラインから操作できるCLIツールを実装します。Typer + Richを使用し、ユーザーフレンドリーで美しい出力を提供します。

### 主要実装内容

1. **CLIメインエントリーポイント**: Typerアプリケーション基盤
2. **createコマンド**: Markdown → PowerPoint変換
3. **convertコマンド**: PDF/画像 → PowerPoint変換
4. **設定管理**: YAMLファイル + 環境変数サポート
5. **出力フォーマッター**: Rich libraryによる美しい出力

---

## 🎯 実装ファイル一覧

### 1. CLIメインエントリーポイント
**ファイル**: `src/slidemaker/cli/main.py`

```python
import typer
from pathlib import Path
from typing import Optional

app = typer.Typer(
    name="slidemaker",
    help="AI-powered PowerPoint generator",
    add_completion=False
)

@app.callback()
def main(
    config_file: Optional[Path] = typer.Option(
        None,
        "--config",
        "-c",
        help="Configuration file path"
    ),
    verbose: bool = typer.Option(
        False,
        "--verbose",
        "-v",
        help="Enable verbose output"
    ),
    version: bool = typer.Option(
        False,
        "--version",
        help="Show version information"
    )
):
    """Slidemaker CLI - AI-powered PowerPoint generator"""
    # グローバル設定の初期化
    # ロガー設定
    # バージョン表示

if __name__ == "__main__":
    app()
```

**実装内容**:
- Typerアプリケーション初期化
- グローバルオプション（--config, --verbose, --version）
- サブコマンド登録（create, convert）
- エラーハンドリング
- バージョン情報表示

**依存関係**: typer, rich, `__version__.py`

---

### 2. createコマンド
**ファイル**: `src/slidemaker/cli/commands/create.py`

```python
from pathlib import Path
from typing import Optional
import typer
import asyncio
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn

from slidemaker.workflows.new_slide import NewSlideWorkflow
from slidemaker.cli.config import CLIConfig
from slidemaker.cli.output import OutputFormatter

create_app = typer.Typer()
console = Console()

@create_app.command(name="create")
def create_slides(
    input_file: Path = typer.Argument(
        ...,
        help="Markdown input file",
        exists=True,
        file_okay=True,
        dir_okay=False
    ),
    output: Optional[Path] = typer.Option(
        None,
        "--output",
        "-o",
        help="Output PowerPoint file path"
    ),
    theme: Optional[str] = typer.Option(
        None,
        "--theme",
        help="Theme name"
    ),
    dry_run: bool = typer.Option(
        False,
        "--dry-run",
        help="Preview without generating (output JSON only)"
    )
):
    """Create PowerPoint slides from Markdown"""
    # 設定読み込み
    # NewSlideWorkflowの実行
    # 進捗表示（Rich Progress）
    # 結果出力
```

**実装内容**:
- Markdown入力ファイルのバリデーション
- 出力パス指定（デフォルト: `output/{title}_YYYYMMDD_HHMMSS.pptx`）
- テーマ選択（オプション）
- ドライランモード（JSON出力のみ）
- 進捗表示（Richプログレスバー）
- エラーハンドリング

**依存関係**: Phase 3 (`NewSlideWorkflow`), `config.py`, `output.py`

---

### 3. convertコマンド
**ファイル**: `src/slidemaker/cli/commands/convert.py`

```python
from pathlib import Path
from typing import List, Optional
import typer
import asyncio
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn

from slidemaker.workflows.conversion import ConversionWorkflow
from slidemaker.cli.config import CLIConfig
from slidemaker.cli.output import OutputFormatter

convert_app = typer.Typer()
console = Console()

@convert_app.command(name="convert")
def convert_slides(
    input_files: List[Path] = typer.Argument(
        ...,
        help="PDF or image files",
        exists=True
    ),
    output: Optional[Path] = typer.Option(
        None,
        "--output",
        "-o",
        help="Output PowerPoint file path"
    ),
    analyze_only: bool = typer.Option(
        False,
        "--analyze-only",
        help="Analyze without converting (output JSON analysis)"
    )
):
    """Convert PDF/images to PowerPoint slides"""
    # 設定読み込み
    # ConversionWorkflowの実行
    # 進捗表示（Rich Progress）
    # 結果出力
```

**実装内容**:
- PDF/画像ファイルのバリデーション
- 複数ファイルサポート
- 分析のみモード（JSON出力）
- 進捗表示
- エラーハンドリング

**依存関係**: Phase 4 (`ConversionWorkflow`), `config.py`, `output.py`

---

### 4. 設定管理
**ファイル**: `src/slidemaker/cli/config.py`

```python
from pathlib import Path
from typing import Optional
import yaml
from pydantic import BaseModel

class CLIConfig(BaseModel):
    """CLI設定管理"""

    config_path: Optional[Path] = None
    verbose: bool = False

    def __init__(self, config_path: Optional[Path] = None, verbose: bool = False):
        """設定の初期化"""
        super().__init__(config_path=config_path, verbose=verbose)

    def load(self) -> dict:
        """設定ファイルの読み込み"""
        # 1. デフォルトパス検索（~/.slidemaker/config.yaml）
        # 2. プロジェクトルートのconfig.yaml検索
        # 3. 指定された設定ファイル読み込み
        # 4. 環境変数オーバーライド
        # 5. 設定のマージ

    def get_default_config_path(self) -> Optional[Path]:
        """デフォルト設定パスの取得"""
        # ~/.slidemaker/config.yaml

    @staticmethod
    def merge_config(base: dict, override: dict) -> dict:
        """設定のマージ"""
```

**実装内容**:
- 設定ファイル検索と読み込み（優先順位: 指定ファイル → プロジェクトルート → ホームディレクトリ）
- 環境変数オーバーライド
- デフォルト値の提供
- 設定のマージ

**依存関係**: Phase 1 (`config_loader.py`)

---

### 5. 出力フォーマッター
**ファイル**: `src/slidemaker/cli/output.py`

```python
from pathlib import Path
from typing import Any, Dict
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn
from rich.table import Table
from rich.panel import Panel
import json

class OutputFormatter:
    """CLI出力のフォーマット"""

    def __init__(self, verbose: bool = False):
        self.console = Console()
        self.verbose = verbose

    def print_success(self, message: str, file_path: Path) -> None:
        """成功メッセージの出力"""
        self.console.print(f"[green]✓[/green] {message}")
        self.console.print(f"[blue]→[/blue] {file_path}")

    def print_error(self, error: Exception) -> None:
        """エラーメッセージの出力"""
        self.console.print(f"[red]✗ Error:[/red] {str(error)}")

    def print_progress(self, description: str) -> Progress:
        """進捗バーの作成"""
        return Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(),
            console=self.console
        )

    def print_json(self, data: Dict[str, Any]) -> None:
        """JSON出力"""
        self.console.print_json(json.dumps(data))

    def print_table(self, title: str, headers: list, rows: list) -> None:
        """テーブル出力"""
        table = Table(title=title)
        for header in headers:
            table.add_column(header)
        for row in rows:
            table.add_row(*row)
        self.console.print(table)
```

**実装内容**:
- Rich libraryを使用した美しい出力
- 進捗バー、スピナー
- カラー出力（成功: 緑、エラー: 赤）
- JSON出力オプション
- テーブル出力

**依存関係**: rich

---

## 📅 実装スケジュール

### Week 1: コアCLI実装（3-4日）

#### Day 1-2: 基礎モジュールとcreateコマンド
- [ ] `config.py`の実装
- [ ] `output.py`の実装
- [ ] `commands/create.py`の実装
- [ ] `main.py`の実装（基本部分）

**並列実行可能**: `config.py`と`output.py`は同時実行可能

#### Day 3-4: convertコマンドとメイン統合
- [ ] `commands/convert.py`の実装
- [ ] `main.py`のサブコマンド登録完成
- [ ] エラーハンドリング強化
- [ ] バージョン情報表示

### Week 2: テストと統合（3-4日）

#### Day 1-2: ユニットテスト実装
- [ ] `tests/cli/test_main.py`
- [ ] `tests/cli/test_create.py`
- [ ] `tests/cli/test_convert.py`
- [ ] `tests/cli/test_config.py`
- [ ] `tests/cli/test_output.py`

**並列実行可能**: すべてのテストファイルは独立（4並列推奨）

#### Day 3-4: 統合テストとドキュメント
- [ ] `tests/cli/integration/test_cli_e2e.py`（エンドツーエンド）
- [ ] カバレッジ確認（目標: 80%以上）
- [ ] ドキュメント更新（README.md, getting_started.md）
- [ ] サンプル実行確認

---

## 🤖 必要な専門サブエージェント

### 1. ndf:corder（コーディング実装）

**タスク1: 基礎モジュール実装（並列実行推奨）**
```
指示内容:
「Phase 5 CLIの基礎モジュールを実装してください。

【並列実行グループ1】
- src/slidemaker/cli/config.py: 設定ファイル管理（YAML読み込み、環境変数オーバーライド、デフォルトパス検索）
- src/slidemaker/cli/output.py: Rich libraryによる出力フォーマッター（成功/エラーメッセージ、進捗バー、JSON出力）

実装要件:
- PEP 8準拠、型ヒント必須（mypy strict mode）
- Google形式docstring
- セキュリティ: パストラバーサル防止（config.pyのパス処理）
- 最大行長100文字

参考:
- issues/i006.md: Phase 5実装計画
- examples/config.yaml.example: 設定ファイル例
- src/slidemaker/utils/config_loader.py: 既存の設定管理（Phase 1）
」
```

**タスク2: createコマンド実装（逐次実行）**
```
指示内容:
「Phase 5 CLIのcreateコマンドを実装してください。

実装ファイル:
- src/slidemaker/cli/commands/create.py: Markdown → PowerPoint変換コマンド

実装要件:
- Typer + Richを使用
- NewSlideWorkflow（Phase 3）を呼び出し
- 進捗表示（Rich Progress）
- ドライランモード（--dry-run）サポート
- エラーハンドリング

参考:
- issues/i006.md: Phase 5実装計画
- src/slidemaker/workflows/new_slide.py: NewSlideWorkflow
- src/slidemaker/cli/config.py: 設定管理（Task 1で実装）
」
```

**タスク3: convertコマンドとメイン実装（逐次実行）**
```
指示内容:
「Phase 5 CLIのconvertコマンドとメインエントリーポイントを実装してください。

実装ファイル:
- src/slidemaker/cli/commands/convert.py: PDF/画像 → PowerPoint変換コマンド
- src/slidemaker/cli/main.py: Typerメインアプリケーション（サブコマンド登録、グローバルオプション）

実装要件:
- ConversionWorkflow（Phase 4）を呼び出し
- 複数ファイルサポート
- 分析のみモード（--analyze-only）
- バージョン情報表示（--version）

参考:
- issues/i006.md: Phase 5実装計画
- src/slidemaker/workflows/conversion.py: ConversionWorkflow
- pyproject.toml: エントリーポイント設定
」
```

### 2. ndf:qa（品質保証）

**タスク: コード品質・セキュリティレビュー**
```
指示内容:
「Phase 5 CLIモジュールのコード品質・セキュリティレビューを実施してください。

レビュー対象:
- src/slidemaker/cli/main.py
- src/slidemaker/cli/commands/create.py
- src/slidemaker/cli/commands/convert.py
- src/slidemaker/cli/config.py
- src/slidemaker/cli/output.py

チェック項目:
1. コード品質:
   - 可読性、保守性
   - PEP 8準拠
   - 型ヒント完全性（mypy strict mode）
   - docstring完備（Google形式）

2. セキュリティ（OWASP Top 10準拠）:
   - パストラバーサル対策（config.pyのパス処理）
   - 入力バリデーション（ファイルパス、オプション値）
   - コマンドインジェクション対策

3. ベストプラクティス:
   - Typer使用法
   - Rich library活用
   - エラーハンドリング

Codexでセキュリティスキャンを実施してください。
改善提案があれば具体的なコード例を提示してください。
」
```

### 3. ndf:corder（テスト実装）

**タスク: ユニットテスト実装（並列実行推奨）**
```
指示内容:
「Phase 5 CLIのユニットテストを実装してください。

【並列実行グループ2】（4並列推奨）
- tests/cli/test_main.py: メインアプリケーションのテスト
- tests/cli/test_create.py: createコマンドのテスト
- tests/cli/test_convert.py: convertコマンドのテスト
- tests/cli/test_config.py: 設定管理のテスト
- tests/cli/test_output.py: 出力フォーマッターのテスト

テスト要件:
- pytestフレームワーク使用
- モックを活用（ワークフロー、LLM呼び出し）
- カバレッジ80%以上
- 正常系・異常系の両方テスト

参考:
- issues/i006.md: Phase 5実装計画
- tests/workflows/test_new_slide.py: 既存ワークフローテスト例
- tests/utils/test_config_loader.py: 既存設定管理テスト例
」
```

**タスク: E2Eテスト実装（逐次実行）**
```
指示内容:
「Phase 5 CLIのエンドツーエンドテストを実装してください。

実装ファイル:
- tests/cli/integration/test_cli_e2e.py

テスト内容:
1. createコマンドのE2E:
   - 実際のMarkdownファイルからPowerPoint生成
   - 出力ファイル確認
   - エラーケース（不正なMarkdown、存在しないファイル）

2. convertコマンドのE2E:
   - 実際のPDFからPowerPoint生成
   - 複数ファイル処理
   - エラーケース

3. 設定ファイル読み込み:
   - デフォルトパスからの読み込み
   - 環境変数オーバーライド

テスト要件:
- 実際のCLIコマンド実行（subprocess使用）
- tempfileで一時ファイル管理
- モックLLMで外部API呼び出し回避
」
```

---

## ⚡ 並列実行推奨タスク

### 【並列実行グループ1】: 基礎モジュール実装
**タスク内容**:
- Task A: `config.py`の実装
- Task B: `output.py`の実装

**並列実行理由**:
- ✅ ファイルが完全に独立
- ✅ 相互依存なし
- ✅ メモリ使用量は小（各ファイル約100-150行）

**実行タイミング**: Week 1 Day 1-2

---

### 【並列実行グループ2】: ユニットテスト実装
**タスク内容**:
- Task A: `test_main.py`の実装
- Task B: `test_create.py`の実装
- Task C: `test_convert.py`の実装
- Task D: `test_config.py`の実装
- Task E: `test_output.py`の実装

**並列実行理由**:
- ✅ すべてのテストファイルは独立
- ✅ メモリ使用量は中程度（各ファイル約150-200行）
- ✅ 同時実行でWeek 2を大幅に短縮可能

**推奨並列数**: 4-5並列

**実行タイミング**: Week 2 Day 1-2

---

### 逐次実行が必要なタスク

1. **コマンド実装**:
   - `commands/create.py`, `commands/convert.py`（`config.py`, `output.py`依存）

2. **メインエントリーポイント**:
   - `main.py`（すべてのサブコマンド依存）

3. **E2Eテスト**:
   - `test_cli_e2e.py`（すべての実装完了が前提）

4. **QAレビュー**:
   - すべてのコード実装完了後

---

## 🔒 セキュリティ要件

### 1. パストラバーサル対策
- **対象**: `config.py`のパス処理
- **実装**: `Path.resolve()`で絶対パス化、`output_base_dir`制限

### 2. 入力バリデーション
- **対象**: すべてのコマンドオプション
- **実装**: Typerの型チェック + 追加バリデーション

### 3. コマンドインジェクション対策
- **対象**: ファイルパス、外部コマンド実行（なし）
- **実装**: Typerのパラメータサニタイズ

---

## 📊 テスト要件

### カバレッジ目標
- **ユニットテスト**: 80%以上
- **統合テスト**: 主要コマンド100%
- **E2Eテスト**: createとconvert両方

### テスト構成
```
tests/cli/
├── test_main.py              # メインアプリケーション
├── test_create.py            # createコマンド
├── test_convert.py           # convertコマンド
├── test_config.py            # 設定管理
├── test_output.py            # 出力フォーマッター
└── integration/
    └── test_cli_e2e.py       # エンドツーエンド
```

---

## 📚 参考リンク

### 実装済みモジュール
- **Phase 3**: `src/slidemaker/workflows/new_slide.py` (NewSlideWorkflow)
- **Phase 4**: `src/slidemaker/workflows/conversion.py` (ConversionWorkflow)
- **Phase 1**: `src/slidemaker/utils/config_loader.py` (既存設定管理)

### ドキュメント
- **ロードマップ**: `issues/PLAN01/06_implementation_roadmap.md`
- **設定例**: `examples/config.yaml.example`
- **pyproject.toml**: エントリーポイント設定

### 外部ライブラリ
- **Typer**: https://typer.tiangolo.com/
- **Rich**: https://rich.readthedocs.io/

---

## ✅ 完了基準

1. ✅ すべてのCLIモジュールが実装されている
2. ✅ createコマンドが正常に動作する（Markdown → PowerPoint）
3. ✅ convertコマンドが正常に動作する（PDF/画像 → PowerPoint）
4. ✅ 設定ファイル読み込みが正常に動作する
5. ✅ Rich libraryによる美しい出力が表示される
6. ✅ ユニットテストのカバレッジが80%以上
7. ✅ E2Eテストがすべてパスする
8. ✅ QAレビューで指摘事項がすべて解決されている
9. ✅ ドキュメントが更新されている（README.md, getting_started.md）
10. ✅ サンプル実行で問題なく動作する

---

## 🚀 次のステップ

Phase 5完了後:
1. **Phase 6の準備**: FastAPI バックエンドAPI設計
2. **PyPI公開**: パッケージングとリリース準備
3. **ドキュメント充実**: ユーザーガイド、チュートリアル作成

---

**最終更新**: 2025-12-23
**作成者**: Director Agent
**レビュー状態**: 初版
