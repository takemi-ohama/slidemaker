# Phase 1 残タスク実装計画

**作成日**: 2025-12-20
**担当**: Director Agent
**ステータス**: 計画策定完了

---

## 概要

Phase 1「コアモデルとLLM統合」の残タスク（20%）の詳細実装計画です。既存のClaudeアダプタとAPI基底クラスを参考に、OpenAI GPT、Google Gemini、CLIアダプタの実装、および包括的なユニットテストを実施します。

---

## 調査結果サマリー

### 既存実装の理解

#### APIAdapter基底クラス (`base_api.py`)
- httpxベースの非同期HTTP通信
- 共通エラーハンドリング（401, 429, 4xx/5xx）
- JSON抽出機能（マークダウンコードブロック対応）
- コンテキストマネージャー対応

**主要メソッド:**
- `__init__()`: httpxクライアント初期化
- `api_base_url`: 抽象プロパティ（各アダプタで実装）
- `_build_request_payload()`: 抽象メソッド（リクエストボディ構築）
- `_extract_text_response()`: 抽象メソッド（レスポンステキスト抽出）
- `generate_text()`: テキスト生成実装
- `generate_structured()`: 構造化JSON生成実装
- `_make_request()`: HTTPリクエスト送信
- `_get_headers()`: リクエストヘッダー生成
- `_extract_json()`: レスポンスからJSON抽出

#### ClaudeAdapter (`claude.py`)
- APIAdapter基底クラスを継承
- Claude特有のAPI仕様を実装

**実装内容:**
- `api_base_url`: "https://api.anthropic.com/v1/messages"
- `_get_headers()`: x-api-key, anthropic-version ヘッダー
- `_build_request_payload()`: messagesフォーマット
- `_extract_text_response()`: content[0].text から抽出

### API仕様調査結果

#### OpenAI GPT API（既知の仕様）
- **エンドポイント**: `https://api.openai.com/v1/chat/completions`
- **認証**: `Authorization: Bearer {API_KEY}`
- **リクエスト形式**:
  ```json
  {
    "model": "gpt-4o-mini",
    "messages": [
      {"role": "system", "content": "..."},
      {"role": "user", "content": "..."}
    ],
    "max_tokens": 4096,
    "temperature": 0.7
  }
  ```
- **レスポンス形式**:
  ```json
  {
    "choices": [
      {"message": {"content": "生成されたテキスト"}}
    ]
  }
  ```
  - テキスト抽出パス: `response['choices'][0]['message']['content']`

#### Google Gemini API（WebFetchで取得）
- **エンドポイント**: `https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent`
- **認証**: `x-goog-api-key: {API_KEY}` ヘッダー
- **リクエスト形式**:
  ```json
  {
    "contents": [
      {"parts": [{"text": "質問内容"}]}
    ],
    "generationConfig": {
      "temperature": 0.7,
      "maxOutputTokens": 4096
    }
  }
  ```
- **レスポンス形式**:
  ```json
  {
    "candidates": [
      {"content": {"parts": [{"text": "生成されたテキスト"}]}}
    ]
  }
  ```
  - テキスト抽出パス: `response['candidates'][0]['content']['parts'][0]['text']`

---

## 実装タスク

### タスク1: GPTアダプタ実装

**ファイル**: `src/slidemaker/llm/adapters/api/gpt.py`

**実装方針:**
- APIAdapter基底クラスを継承
- 既存のClaudeAdapterを参考にする

**実装メソッド:**
1. `api_base_url`: プロパティ（`https://api.openai.com/v1/chat/completions`）
2. `_get_headers()`: Authorization Bearer認証
3. `_build_request_payload()`: OpenAI Chat Completions形式
4. `_extract_text_response()`: `choices[0]['message']['content']` から抽出

**推定規模**: 50-80行

**参考ファイル:**
- `src/slidemaker/llm/adapters/api/claude.py`
- `src/slidemaker/llm/adapters/api/base_api.py`

---

### タスク2: Geminiアダプタ実装

**ファイル**: `src/slidemaker/llm/adapters/api/gemini.py`

**実装方針:**
- APIAdapter基底クラスを継承
- 既存のClaudeAdapterを参考にする

**実装メソッド:**
1. `api_base_url`: プロパティ（動的にモデル名を挿入）
   - `f"https://generativelanguage.googleapis.com/v1beta/models/{self.model}:generateContent"`
2. `_get_headers()`: `x-goog-api-key` 認証
3. `_build_request_payload()`: Gemini contents形式
4. `_extract_text_response()`: `candidates[0]['content']['parts'][0]['text']` から抽出

**推定規模**: 50-80行

**参考ファイル:**
- `src/slidemaker/llm/adapters/api/claude.py`
- `src/slidemaker/llm/adapters/api/base_api.py`

---

### タスク3: CLI基底クラス実装

**ファイル**: `src/slidemaker/llm/adapters/cli/base_cli.py`

**実装方針:**
- LLMAdapter基底クラスを継承
- subprocess経由でCLIツールを呼び出す

**実装メソッド:**
1. `__init__(cli_path: str, model: str, timeout: int)`: CLIコマンドパス、引数テンプレート
2. `_build_command(prompt: str, system_prompt: str | None, **kwargs) -> list[str]`: コマンドライン構築（抽象メソッド）
3. `_run_cli(command: list[str]) -> str`: `subprocess.run()`でCLI実行
4. `_parse_output(raw_output: str) -> str`: 標準出力からテキスト抽出（抽象メソッド）
5. `generate_text(prompt: str, system_prompt: str | None, **kwargs) -> str`: `_run_cli()`と`_parse_output()`の組み合わせ
6. `generate_structured(prompt: str, system_prompt: str | None, schema: dict | None) -> dict`: JSON出力を想定

**エラーハンドリング:**
- `subprocess.CalledProcessError` → `LLMError`
- `subprocess.TimeoutExpired` → `LLMTimeoutError`

**推定規模**: 100-150行

---

### タスク4: Claude Codeアダプタ実装

**ファイル**: `src/slidemaker/llm/adapters/cli/claude_code.py`

**実装方針:**
- BaseCLIAdapter基底クラスを継承
- Claude Codeコマンド (`claude-code`) を呼び出す

**実装メソッド:**
1. `_build_command()`: `claude-code`用のコマンドライン構築
   - 例: `["claude-code", "--model", self.model, "--prompt", prompt]`
2. `_parse_output()`: 標準出力からレスポンス抽出

**推定規模**: 50-80行

---

### タスク5: Codex CLIアダプタ実装

**ファイル**: `src/slidemaker/llm/adapters/cli/codex_cli.py`

**実装方針:**
- BaseCLIAdapter基底クラスを継承
- Codex CLIコマンド (`codex`) を呼び出す

**実装メソッド:**
1. `_build_command()`: `codex`用のコマンドライン構築
   - 例: `["codex", "chat", "--model", self.model, prompt]`
2. `_parse_output()`: 標準出力からレスポンス抽出

**推定規模**: 50-80行

---

### タスク6: Gemini CLIアダプタ実装

**ファイル**: `src/slidemaker/llm/adapters/cli/gemini_cli.py`

**実装方針:**
- BaseCLIAdapter基底クラスを継承
- Gemini CLIコマンド (`gemini-cli` または `gcloud ai`) を呼び出す

**実装メソッド:**
1. `_build_command()`: `gemini-cli`用のコマンドライン構築
   - 例: `["gemini-cli", "generate", "--model", self.model, "--prompt", prompt]`
2. `_parse_output()`: 標準出力からレスポンス抽出

**推定規模**: 50-80行

---

### タスク7: 包括的なユニットテスト実装

**対象ファイル:**
1. `tests/core/test_models.py` - データモデル
2. `tests/core/test_serializers.py` - シリアライザ
3. `tests/utils/test_config_loader.py` - 設定ローダー
4. `tests/utils/test_file_manager.py` - ファイルマネージャー（セキュリティテスト含む）
5. `tests/llm/test_manager.py` - LLMマネージャー
6. `tests/llm/adapters/test_api_adapters.py` - APIアダプタ（mock使用）
7. `tests/llm/adapters/test_cli_adapters.py` - CLIアダプタ（mock使用）

**実装方針:**
- pytest + pytest-asyncio使用
- モックを活用（httpx, subprocess）
- カバレッジ80%以上を目指す
- セキュリティテスト（パストラバーサル、RGB検証等）を含める

**推定規模**: 各テストファイル 100-300行

---

## 並列実行可能性の判断

### ✅ 並列実行可能なタスク（推奨）

#### グループA: APIアダプタ実装（並列実行可）

**タスク1（GPTアダプタ）とタスク2（Geminiアダプタ）**

**理由:**
- ✅ 対象ファイルが完全に独立（`gpt.py`, `gemini.py`）
- ✅ 両方とも同じAPI基底クラスを継承（読み込みのみ、書き込みなし）
- ✅ タスク間の依存関係なし
- ✅ メモリ使用量: 各タスク「小」（50-80行のシンプルなアダプタ実装）

**並列数推奨**: 2並列

---

#### グループB: CLI基底クラス実装（逐次実行）

**タスク3（CLI基底クラス）**

**理由:**
- ⚠️ タスク4-6がタスク3に依存（base_cli.pyを継承）
- ⚠️ 先に完了させる必要がある

---

#### グループC: 個別CLIアダプタ（並列実行可）

**タスク4（Claude Code）、タスク5（Codex CLI）、タスク6（Gemini CLI）**

**理由:**
- ✅ 対象ファイルが完全に独立（`claude_code.py`, `codex_cli.py`, `gemini_cli.py`）
- ✅ 全てBaseCLIAdapterを継承（読み込みのみ、書き込みなし）
- ✅ タスク間の依存関係なし
- ✅ メモリ使用量: 各タスク「小」（50-80行のシンプルなアダプタ実装）

**並列数推奨**: 3並列

---

### ⏳ 逐次実行が必要なタスク

#### グループD: ユニットテスト（実装完了後に実行）

**タスク7（ユニットテスト）**

**理由:**
- ⚠️ すべてのアダプタ実装が完了してからテストを作成（依存関係あり）
- ⚠️ 実装を確認しながらテストケースを設計

---

## 推奨実行順序

### フェーズ1: APIアダプタ並列実装

**Main Agentへの指示:**
```
【並列実行推奨】
タスク1（GPTアダプタ）とタスク2（Geminiアダプタ）を並列で実行してください。

ndf:corder エージェントを2つ同時起動:
- corder #1: タスク1（GPTアダプタ）
- corder #2: タスク2（Geminiアダプタ）

理由:
- 対象ファイルが完全に独立（gpt.py, gemini.py）
- タスク間の依存関係なし
- 各タスクのメモリ使用量: 小
```

---

### フェーズ2: CLI基底クラス実装（逐次）

**Main Agentへの指示:**
```
【逐次実行】
タスク3（CLI基底クラス）を実行してください。

ndf:corder エージェントを1つ起動:
- corder #1: タスク3（CLI基底クラス）

理由:
- タスク4-6がタスク3に依存
```

---

### フェーズ3: 個別CLIアダプタ並列実装

**Main Agentへの指示:**
```
【並列実行推奨】
タスク4（Claude Code）、タスク5（Codex CLI）、タスク6（Gemini CLI）を並列で実行してください。

ndf:corder エージェントを3つ同時起動:
- corder #1: タスク4（Claude Codeアダプタ）
- corder #2: タスク5（Codex CLIアダプタ）
- corder #3: タスク6（Gemini CLIアダプタ）

理由:
- 対象ファイルが完全に独立（claude_code.py, codex_cli.py, gemini_cli.py）
- タスク間の依存関係なし
- 各タスクのメモリ使用量: 小
```

---

### フェーズ4: ユニットテスト実装（逐次）

**Main Agentへの指示:**
```
【逐次実行】
タスク7（ユニットテスト）を実行してください。

ndf:corder エージェントを1つ起動:
- corder #1: タスク7（包括的なユニットテスト）

理由:
- すべてのアダプタ実装が完了してからテストを作成
```

---

## 必要なサブエージェント

### ndf:corder（コーディング専門） - 必須

すべてのタスク（1-7）は**コーディング実装**であり、`ndf:corder`エージェントが必要です。

---

## Main Agentへの詳細指示

### タスク1: GPTアダプタ実装

```
ndf:corder エージェントに以下を指示してください:

「src/slidemaker/llm/adapters/api/gpt.py を実装してください。

【要件】
- APIAdapter基底クラスを継承
- 既存のClaudeAdapterを参考にする
- 以下のメソッドを実装:
  1. api_base_url: "https://api.openai.com/v1/chat/completions"
  2. _get_headers(): Authorization Bearer認証
  3. _build_request_payload(): OpenAI Chat Completions形式
     - model, messages (system + user), max_tokens, temperature
  4. _extract_text_response(): choices[0]['message']['content'] から抽出

【OpenAI GPT API仕様】
- エンドポイント: https://api.openai.com/v1/chat/completions
- 認証ヘッダー: Authorization: Bearer {API_KEY}
- リクエスト形式:
  {
    "model": "gpt-4o-mini",
    "messages": [
      {"role": "system", "content": "..."},
      {"role": "user", "content": "..."}
    ],
    "max_tokens": 4096,
    "temperature": 0.7
  }
- レスポンス形式: {"choices": [{"message": {"content": "..."}}]}

【参考ファイル】
- src/slidemaker/llm/adapters/api/claude.py
- src/slidemaker/llm/adapters/api/base_api.py

実装後、Codexでコードレビューを実施してください。」
```

---

### タスク2: Geminiアダプタ実装

```
ndf:corder エージェントに以下を指示してください:

「src/slidemaker/llm/adapters/api/gemini.py を実装してください。

【要件】
- APIAdapter基底クラスを継承
- 既存のClaudeAdapterを参考にする
- 以下のメソッドを実装:
  1. api_base_url: 動的にモデル名を挿入
     - f"https://generativelanguage.googleapis.com/v1beta/models/{self.model}:generateContent"
  2. _get_headers(): x-goog-api-key認証
  3. _build_request_payload(): Gemini contents形式
     - contents: [{"parts": [{"text": "..."}]}]
     - generationConfig: {"temperature": ..., "maxOutputTokens": ...}
  4. _extract_text_response(): candidates[0]['content']['parts'][0]['text'] から抽出

【Gemini API仕様】
- エンドポイント: https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent
- 認証ヘッダー: x-goog-api-key: {API_KEY}
- リクエスト形式:
  {
    "contents": [{"parts": [{"text": "質問内容"}]}],
    "generationConfig": {"temperature": 0.7, "maxOutputTokens": 4096}
  }
- レスポンス形式: {"candidates": [{"content": {"parts": [{"text": "..."}]}}]}

【参考ファイル】
- src/slidemaker/llm/adapters/api/claude.py
- src/slidemaker/llm/adapters/api/base_api.py

実装後、Codexでコードレビューを実施してください。」
```

---

### タスク3: CLI基底クラス実装

```
ndf:corder エージェントに以下を指示してください:

「src/slidemaker/llm/adapters/cli/base_cli.py を実装してください。

【要件】
- LLMAdapter基底クラスを継承
- subprocess経由でCLIツールを呼び出す
- 以下のメソッドを実装:
  1. __init__(cli_path: str, model: str, timeout: int): CLIコマンドパス、引数テンプレート
  2. _build_command(prompt: str, system_prompt: str | None, **kwargs) -> list[str]: コマンドライン構築（抽象メソッド）
  3. _run_cli(command: list[str]) -> str: subprocess.run()でCLI実行
  4. _parse_output(raw_output: str) -> str: 標準出力からテキスト抽出（抽象メソッド）
  5. generate_text(prompt: str, system_prompt: str | None, **kwargs) -> str: _run_cli()と_parse_output()の組み合わせ
  6. generate_structured(prompt: str, system_prompt: str | None, schema: dict | None) -> dict: JSON出力を想定

【実装方針】
- API型と同様のインターフェースを提供
- エラーハンドリング:
  - subprocess.CalledProcessError → LLMError
  - subprocess.TimeoutExpired → LLMTimeoutError
- タイムアウト処理（timeout引数をsubprocess.run()に渡す）

【参考ファイル】
- src/slidemaker/llm/base.py（LLMAdapter基底クラス）
- src/slidemaker/llm/adapters/api/base_api.py（API型の実装パターン）

実装後、Codexでコードレビューを実施してください。」
```

---

### タスク4: Claude Codeアダプタ実装

```
ndf:corder エージェントに以下を指示してください:

「src/slidemaker/llm/adapters/cli/claude_code.py を実装してください。

【要件】
- BaseCLIAdapter基底クラスを継承
- Claude Codeコマンド (claude-code) を呼び出す
- 以下のメソッドを実装:
  1. _build_command(): claude-code用のコマンドライン構築
     - 例: ["claude-code", "--model", self.model, "--prompt", prompt]
  2. _parse_output(): 標準出力からレスポンス抽出

【参考ファイル】
- src/slidemaker/llm/adapters/cli/base_cli.py

実装後、Codexでコードレビューを実施してください。」
```

---

### タスク5: Codex CLIアダプタ実装

```
ndf:corder エージェントに以下を指示してください:

「src/slidemaker/llm/adapters/cli/codex_cli.py を実装してください。

【要件】
- BaseCLIAdapter基底クラスを継承
- Codex CLIコマンド (codex) を呼び出す
- 以下のメソッドを実装:
  1. _build_command(): codex用のコマンドライン構築
     - 例: ["codex", "chat", "--model", self.model, prompt]
  2. _parse_output(): 標準出力からレスポンス抽出

【参考ファイル】
- src/slidemaker/llm/adapters/cli/base_cli.py

実装後、Codexでコードレビューを実施してください。」
```

---

### タスク6: Gemini CLIアダプタ実装

```
ndf:corder エージェントに以下を指示してください:

「src/slidemaker/llm/adapters/cli/gemini_cli.py を実装してください。

【要件】
- BaseCLIAdapter基底クラスを継承
- Gemini CLIコマンド (gemini-cli または gcloud ai) を呼び出す
- 以下のメソッドを実装:
  1. _build_command(): gemini-cli用のコマンドライン構築
     - 例: ["gemini-cli", "generate", "--model", self.model, "--prompt", prompt]
  2. _parse_output(): 標準出力からレスポンス抽出

【参考ファイル】
- src/slidemaker/llm/adapters/cli/base_cli.py

実装後、Codexでコードレビューを実施してください。」
```

---

### タスク7: 包括的なユニットテスト実装

```
ndf:corder エージェントに以下を指示してください:

「Phase 1の全モジュールに対する包括的なユニットテストを実装してください。

【対象ファイル】
1. tests/core/test_models.py - データモデル
2. tests/core/test_serializers.py - シリアライザ
3. tests/utils/test_config_loader.py - 設定ローダー
4. tests/utils/test_file_manager.py - ファイルマネージャー（セキュリティテスト含む）
5. tests/llm/test_manager.py - LLMマネージャー
6. tests/llm/adapters/test_api_adapters.py - APIアダプタ（mock使用）
7. tests/llm/adapters/test_cli_adapters.py - CLIアダプタ（mock使用）

【要件】
- pytest + pytest-asyncio使用
- モックを活用（httpx, subprocess）
- カバレッジ80%以上を目指す
- セキュリティテスト（パストラバーサル、RGB検証等）を含める

【実装方針】
1. 各モジュールの主要機能をテスト
2. 正常系と異常系の両方をカバー
3. エッジケースのテスト
4. モックを使用してLLM APIへの実際の呼び出しを回避

【セキュリティテスト（file_manager.py）】
- パストラバーサル攻撃のテスト（../../../etc/passwd等）
- output_base_dirの範囲外へのアクセス防止確認

【参考ファイル】
- tests/test_version.py（既存のテスト例）

実装後、pytestを実行してすべてのテストが通ることを確認してください。」
```

---

## メトリクス

### 推定工数

| タスク | 推定規模 | 推定工数 | 備考 |
|--------|----------|----------|------|
| タスク1: GPTアダプタ | 50-80行 | 0.5-1日 | 既存実装参考可 |
| タスク2: Geminiアダプタ | 50-80行 | 0.5-1日 | 既存実装参考可 |
| タスク3: CLI基底クラス | 100-150行 | 1-2日 | 新規設計 |
| タスク4: Claude Codeアダプタ | 50-80行 | 0.5-1日 | CLI基底クラス継承 |
| タスク5: Codex CLIアダプタ | 50-80行 | 0.5-1日 | CLI基底クラス継承 |
| タスク6: Gemini CLIアダプタ | 50-80行 | 0.5-1日 | CLI基底クラス継承 |
| タスク7: ユニットテスト | 700-2100行 | 3-5日 | 全モジュール対象 |
| **合計** | **1050-2650行** | **7-12日** | 並列実行で短縮可能 |

### 並列実行による短縮効果

**逐次実行の場合:** 7-12日
**並列実行の場合:** 5-8日（約30-40%短縮）

**内訳:**
- フェーズ1（APIアダプタ並列）: 0.5-1日（逐次なら1-2日）
- フェーズ2（CLI基底クラス）: 1-2日
- フェーズ3（CLIアダプタ並列）: 0.5-1日（逐次なら1.5-3日）
- フェーズ4（ユニットテスト）: 3-5日

---

## 依存関係図

```
Phase 1 残タスク依存関係
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────┐
│   既存実装 (Phase 1: 80%完了)   │
│ ・APIAdapter基底クラス          │
│ ・ClaudeAdapter                 │
│ ・LLMAdapter基底クラス          │
│ ・データモデル、ユーティリティ  │
└────────────┬────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
    v                 v
┌─────────┐     ┌─────────┐
│ タスク1 │     │ タスク2 │
│   GPT   │     │ Gemini  │
│ アダプタ│     │アダプタ │
└─────────┘     └─────────┘
  (並列実行可)     (並列実行可)
             │
             v
      ┌──────────┐
      │ タスク3  │
      │   CLI    │
      │基底クラス│
      └────┬─────┘
           │
    ┌──────┴──────────┬──────────┐
    v                 v          v
┌─────────┐     ┌─────────┐  ┌─────────┐
│ タスク4 │     │ タスク5 │  │ タスク6 │
│ Claude  │     │  Codex  │  │ Gemini  │
│  Code   │     │   CLI   │  │   CLI   │
└─────────┘     └─────────┘  └─────────┘
  (並列実行可)     (並列実行可)  (並列実行可)
             │
             v
      ┌──────────┐
      │ タスク7  │
      │ ユニット │
      │ テスト   │
      └──────────┘
```

---

## 品質保証

### コードレビュー
- 各タスク実装後、Codexでコードレビューを実施
- セキュリティ、パフォーマンス、コーディング規約の確認

### テストカバレッジ目標
- ユニットテスト: 80%以上
- 主要機能: 100%カバー

### セキュリティチェックリスト
- [ ] パストラバーサル攻撃防止（file_manager.py）
- [ ] RGB値範囲検証（common.py）
- [ ] JSON解析エラーハンドリング（json_serializer.py）
- [ ] 環境変数展開のstrictモード（config_loader.py）
- [ ] API認証エラーハンドリング（全アダプタ）
- [ ] タイムアウトエラーハンドリング（全アダプタ）

---

## 次のステップ

Phase 1完了後、Phase 2「PowerPoint生成機能」の実装に進みます。

**Phase 2の主要タスク:**
- PowerPointGenerator（python-pptxラッパー）
- SlideBuilder（個別スライド構築）
- TextRenderer（テキスト要素レンダリング）
- ImageRenderer（画像要素レンダリング）

詳細: [issues/PLAN01/06_implementation_roadmap.md](PLAN01/06_implementation_roadmap.md)

---

## 参考資料

- [Phase 1実装サマリー](../docs/phase1_summary.md)
- [プロジェクト概要](PLAN01/00_overview.md)
- [アーキテクチャ設計](PLAN01/01_architecture.md)
- [モジュール構成](PLAN01/02_module_structure.md)
- [技術スタック](PLAN01/03_technology_stack.md)
- [開発フェーズ](PLAN01/04_development_phases.md)

---

**作成者**: Director Agent
**最終更新**: 2025-12-20
**ステータス**: 計画策定完了 → Main Agentへの報告準備完了
