# Issue #003: Phase 2 - PowerPoint生成機能の実装

**作成日**: 2025-12-21
**フェーズ**: Phase 2
**推定工数**: 2-3週
**推定規模**: 中規模（約800-1000行）
**優先度**: High
**依存関係**: Phase 1（コアモデルとLLM統合）完了済み

---

## 概要

python-pptxライブラリを使用して、Phase 1で定義したデータモデル（PageDefinition、ElementDefinition等）から実際のPowerPointファイル（.pptx）を生成する機能を実装します。

### 目標

- データモデル → PowerPointファイルの変換パイプライン構築
- テキスト・画像要素のレンダリング
- スライドサイズ・背景・スタイルの適用
- テストカバレッジ80%以上達成

---

## 実装モジュール一覧

### 1. PowerPointGenerator（コアジェネレーター）

**ファイル**: `src/slidemaker/pptx/generator.py`

**責務**:
- python-pptx.Presentationオブジェクトのラッパー
- スライド生成の全体フロー制御
- ファイル保存処理

**主要クラス・メソッド**:

```python
class PowerPointGenerator:
    """PowerPoint生成のメインクラス"""

    def __init__(self, config: SlideConfig):
        """
        Args:
            config: スライド設定（サイズ、デフォルトフォント等）
        """
        self.config = config
        self.presentation: Presentation = Presentation()
        self._apply_slide_config()

    async def generate(
        self,
        pages: list[PageDefinition],
        output_path: str | Path
    ) -> Path:
        """
        スライドデッキの生成

        Args:
            pages: ページ定義のリスト
            output_path: 出力先パス

        Returns:
            Path: 生成されたPowerPointファイルのパス

        Raises:
            FileManagerError: ファイル保存失敗時
        """

    def _apply_slide_config(self) -> None:
        """スライドサイズと設定の適用"""
        # 4:3 (Standard), 16:9 (Widescreen), 16:10 (Widescreen)
```

**依存関係**:
- Phase 1: `SlideConfig`, `PageDefinition`
- python-pptx: `Presentation`
- `SlideBuilder`（後述）

**テストポイント**:
- Presentationオブジェクトの初期化
- スライドサイズ設定（4:3、16:9、16:10）
- 複数ページの生成
- ファイル保存

---

### 2. SlideBuilder（個別スライド構築）

**ファイル**: `src/slidemaker/pptx/slide_builder.py`

**責務**:
- PageDefinitionから1枚のスライドを構築
- 背景設定
- 要素（テキスト、画像）の配置

**主要クラス・メソッド**:

```python
class SlideBuilder:
    """個別スライドの構築"""

    def __init__(self, presentation: Presentation):
        """
        Args:
            presentation: python-pptx Presentationオブジェクト
        """

    def build_slide(self, page: PageDefinition) -> Slide:
        """
        ページ定義から1枚のスライドを構築

        Args:
            page: ページ定義

        Returns:
            Slide: 構築されたスライド

        Raises:
            ValueError: 無効なページ定義時
        """

    def _add_background(
        self,
        slide: Slide,
        background: BackgroundConfig | None
    ) -> None:
        """背景の追加（色または画像）"""

    def _add_elements(
        self,
        slide: Slide,
        elements: list[ElementDefinition]
    ) -> None:
        """要素の追加（TextRendererとImageRendererを使用）"""
```

**依存関係**:
- Phase 1: `PageDefinition`, `BackgroundConfig`, `ElementDefinition`
- python-pptx: `Presentation`, `Slide`
- `TextRenderer`（後述）
- `ImageRenderer`（後述）

**テストポイント**:
- 空白スライドの作成
- 背景色の設定
- 背景画像の設定
- 要素の配置順序

---

### 3. TextRenderer（テキスト要素レンダリング）

**ファイル**: `src/slidemaker/pptx/renderers/text_renderer.py`

**責務**:
- TextElementからテキストボックスを生成
- フォント設定（名前、サイズ、色、太字、斜体）
- 配置設定（左寄せ、中央寄せ、右寄せ）

**主要クラス・メソッド**:

```python
class TextRenderer:
    """テキスト要素のレンダリング"""

    def render(self, slide: Slide, element: TextElement) -> None:
        """
        テキストボックスの作成と設定

        Args:
            slide: 対象スライド
            element: テキスト要素定義

        Raises:
            ValueError: 無効な位置・サイズ・フォント設定時
        """

    def _apply_font_config(
        self,
        text_frame: TextFrame,
        config: FontConfig
    ) -> None:
        """フォント設定の適用"""

    def _apply_alignment(
        self,
        paragraph: Paragraph,
        alignment: Alignment
    ) -> None:
        """テキスト配置の適用"""

    def _convert_color(self, color: Color) -> RGBColor:
        """Color → python-pptx RGBColorへの変換"""
```

**依存関係**:
- Phase 1: `TextElement`, `FontConfig`, `Alignment`, `Color`, `Position`, `Size`
- python-pptx: `Slide`, `TextFrame`, `Paragraph`, `RGBColor`

**テストポイント**:
- テキストボックスの位置・サイズ
- フォント名、サイズ、色
- 太字、斜体の適用
- 配置（左/中央/右）
- RGB色の正確な変換

---

### 4. ImageRenderer（画像要素レンダリング）

**ファイル**: `src/slidemaker/pptx/renderers/image_renderer.py`

**責務**:
- ImageElementから画像を配置
- フィット方式（contain/cover/fill）の適用
- アスペクト比の維持

**主要クラス・メソッド**:

```python
class ImageRenderer:
    """画像要素のレンダリング"""

    def render(self, slide: Slide, element: ImageElement) -> None:
        """
        画像の追加

        Args:
            slide: 対象スライド
            element: 画像要素定義

        Raises:
            FileNotFoundError: 画像ファイルが存在しない場合
            ValueError: 無効な位置・サイズ・フィット方式時
        """

    def _apply_fit_mode(
        self,
        image_path: Path,
        position: Position,
        size: Size,
        fit_mode: FitMode
    ) -> tuple[Position, Size]:
        """
        フィット方式に応じた位置・サイズ調整

        Args:
            image_path: 画像ファイルパス
            position: 配置位置
            size: 配置サイズ
            fit_mode: フィット方式（contain/cover/fill）

        Returns:
            tuple[Position, Size]: 調整後の位置とサイズ
        """

    def _get_image_dimensions(self, image_path: Path) -> tuple[int, int]:
        """画像の実サイズを取得（Pillowを使用）"""
```

**依存関係**:
- Phase 1: `ImageElement`, `FitMode`, `Position`, `Size`
- python-pptx: `Slide`
- Pillow: `Image`

**テストポイント**:
- 画像の位置・サイズ
- containモード（アスペクト比維持、余白あり）
- coverモード（アスペクト比維持、余白なし）
- fillモード（引き伸ばし）
- 画像形式サポート（PNG, JPEG, GIF）

---

### 5. StyleApplier（スタイル適用器）

**ファイル**: `src/slidemaker/pptx/style_applier.py`

**責務**:
- スライド全体のテーマ適用
- デフォルトフォントの設定
- マスタースライドのカスタマイズ

**主要クラス・メソッド**:

```python
class StyleApplier:
    """スライド全体のスタイル適用"""

    def apply_theme(
        self,
        presentation: Presentation,
        theme: dict[str, Any]
    ) -> None:
        """
        テーマの適用

        Args:
            presentation: Presentationオブジェクト
            theme: テーマ定義（カラースキーム、フォント等）
        """

    def apply_master_slide(
        self,
        presentation: Presentation,
        master_config: dict[str, Any]
    ) -> None:
        """
        マスタースライドの適用

        Args:
            presentation: Presentationオブジェクト
            master_config: マスタースライド設定
        """

    def set_default_font(
        self,
        presentation: Presentation,
        font_name: str,
        font_size: int
    ) -> None:
        """デフォルトフォントの設定"""
```

**依存関係**:
- python-pptx: `Presentation`

**テストポイント**:
- テーマの適用
- デフォルトフォントの設定
- マスタースライドのカスタマイズ

---

## ディレクトリ構造

```
src/slidemaker/pptx/
├── __init__.py
├── generator.py              # PowerPointGenerator
├── slide_builder.py          # SlideBuilder
├── style_applier.py          # StyleApplier
└── renderers/
    ├── __init__.py
    ├── text_renderer.py      # TextRenderer
    └── image_renderer.py     # ImageRenderer
```

---

## テスト実装

### tests/pptx/test_generator.py

**カバレッジ**: PowerPointGenerator

```python
import pytest
from pathlib import Path
from slidemaker.pptx.generator import PowerPointGenerator
from slidemaker.core.models import SlideConfig, PageDefinition

class TestPowerPointGenerator:
    def test_init_presentation(self):
        """Presentationオブジェクトの初期化テスト"""

    def test_apply_slide_size_16_9(self):
        """16:9スライドサイズ設定テスト"""

    def test_apply_slide_size_4_3(self):
        """4:3スライドサイズ設定テスト"""

    @pytest.mark.asyncio
    async def test_generate_single_page(self, tmp_path: Path):
        """単一ページの生成テスト"""

    @pytest.mark.asyncio
    async def test_generate_multiple_pages(self, tmp_path: Path):
        """複数ページの生成テスト"""

    @pytest.mark.asyncio
    async def test_generate_file_save(self, tmp_path: Path):
        """ファイル保存のテスト"""
```

### tests/pptx/test_slide_builder.py

**カバレッジ**: SlideBuilder

```python
class TestSlideBuilder:
    def test_build_blank_slide(self):
        """空白スライドの構築テスト"""

    def test_add_background_color(self):
        """背景色設定テスト"""

    def test_add_background_image(self):
        """背景画像設定テスト"""

    def test_add_elements_order(self):
        """要素配置順序のテスト"""
```

### tests/pptx/test_renderers.py

**カバレッジ**: TextRenderer, ImageRenderer

```python
class TestTextRenderer:
    def test_render_text_element(self):
        """テキスト要素レンダリングテスト"""

    def test_apply_font_config(self):
        """フォント設定適用テスト"""

    def test_apply_alignment_left(self):
        """左寄せ配置テスト"""

    def test_apply_alignment_center(self):
        """中央寄せ配置テスト"""

    def test_apply_alignment_right(self):
        """右寄せ配置テスト"""

    def test_convert_color_rgb(self):
        """RGB色変換テスト"""

class TestImageRenderer:
    def test_render_image_element(self):
        """画像要素レンダリングテスト"""

    def test_apply_fit_mode_contain(self):
        """containフィット方式テスト"""

    def test_apply_fit_mode_cover(self):
        """coverフィット方式テスト"""

    def test_apply_fit_mode_fill(self):
        """fillフィット方式テスト"""

    def test_get_image_dimensions(self):
        """画像サイズ取得テスト"""
```

### tests/pptx/integration/test_full_generation.py

**カバレッジ**: エンドツーエンド統合テスト

```python
class TestFullGeneration:
    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_generate_simple_deck(self, tmp_path: Path):
        """シンプルなスライドデッキの生成テスト"""

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_generate_complex_deck(self, tmp_path: Path):
        """複雑なスライドデッキの生成テスト（テキスト+画像混在）"""

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_generate_with_background(self, tmp_path: Path):
        """背景画像付きスライドデッキの生成テスト"""
```

---

## マイルストーン

### Week 1: コアジェネレーターとスライドビルダー

- [ ] PowerPointGeneratorの基本実装
  - [ ] Presentationオブジェクト初期化
  - [ ] スライドサイズ設定（4:3、16:9、16:10）
  - [ ] ファイル保存処理
- [ ] SlideBuilderの実装
  - [ ] 空白スライド作成
  - [ ] 背景色設定
  - [ ] 背景画像設定（オプション）
- [ ] ユニットテスト（test_generator.py、test_slide_builder.py）

### Week 2: レンダラー実装

- [ ] TextRendererの実装
  - [ ] テキストボックス作成
  - [ ] フォント設定適用
  - [ ] 配置設定適用
  - [ ] RGB色変換
- [ ] ImageRendererの実装
  - [ ] 画像追加
  - [ ] フィット方式適用（contain/cover/fill）
  - [ ] アスペクト比計算
- [ ] ユニットテスト（test_renderers.py）

### Week 3: スタイル適用と統合テスト

- [ ] StyleApplierの実装
  - [ ] テーマ適用
  - [ ] マスタースライド設定
  - [ ] デフォルトフォント設定
- [ ] 統合テスト（test_full_generation.py）
- [ ] カバレッジ確認（目標80%以上）
- [ ] サンプルPowerPoint生成の動作確認
- [ ] ドキュメント更新（docstring、README）

---

## 品質基準

### コードカバレッジ
- **ユニットテスト**: 80%以上
- **統合テスト**: 主要ワークフロー100%

### パフォーマンス
- **スライド生成速度**: 10スライド/分以上

### セキュリティ
- **ファイル操作**: パストラバーサル対策（Phase 1のFileManager使用）
- **入力検証**: RGB値検証（0-255）、座標・サイズの正値検証

### コーディング規約
- **PEP 8準拠**
- **型ヒント必須**（mypy strict mode）
- **docstring**: Google形式
- **最大行長**: 100文字

---

## 依存ライブラリ

以下はすでにpyproject.tomlに含まれています：

```toml
dependencies = [
    "python-pptx>=0.6.21",  # PowerPoint生成
    "Pillow>=10.0.0",       # 画像処理（サイズ取得）
    "pydantic>=2.0.0",      # データモデル（Phase 1から継続）
]
```

---

## リスク管理

### 技術リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| python-pptx APIの制限 | 中 | 事前調査（researcher エージェント推奨）、代替手段の検討 |
| 画像フィット方式の複雑さ | 中 | Pillowで正確なサイズ計算、豊富なユニットテスト |
| フォント互換性の問題 | 低 | デフォルトフォント（Arial等）の使用、フォント存在チェック |
| パフォーマンス | 低 | 非同期処理活用、大量スライドは後回し |

### スケジュールリスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| python-pptx学習コスト | 中 | researcher エージェントで事前調査、サンプルコード作成 |
| テストデータ作成の手間 | 低 | フィクスチャの再利用、モックの活用 |
| 統合テストの不安定さ | 低 | ファイルI/O最小化、tmp_pathフィクスチャ使用 |

---

## 必要なサブエージェント

### 1. researcher エージェント（推奨）

**タスク**: python-pptx公式ドキュメントの調査

**目的**:
- Presentationオブジェクトの作成方法
- スライドサイズ設定の具体的な方法
- テキストボックス・画像追加のAPIメソッド
- 背景色・背景画像設定の方法
- フォント設定のベストプラクティス

**指示内容**:
```
python-pptx公式ドキュメント（https://python-pptx.readthedocs.io/）を調査してください。

以下の情報を抽出：
1. Presentationオブジェクトの作成方法（コード例）
2. スライドサイズ設定方法（4:3、16:9、16:10）
3. 新しいスライド追加方法（空白スライド、レイアウト指定）
4. テキストボックス追加と設定（位置、サイズ、フォント、配置）
5. 画像追加と設定（位置、サイズ、フィット方式）
6. 背景色・背景画像の設定方法
7. マスタースライドとテーマのカスタマイズ方法

各項目について具体的なコード例とAPIメソッドシグネチャを含めてください。
```

### 2. corder エージェント（実装フェーズ）

**タスク**: 各モジュールの実装とCodexレビュー

**実行タイミング**: researcher エージェントの調査完了後

**並列実行可能性**:
- ✅ **並列実行推奨**: PowerPointGenerator、SlideBuilder、TextRenderer、ImageRenderer、StyleApplierは独立したモジュールのため並列実装可能
- **条件**: 対象ファイルが完全に異なる

**指示内容（例: PowerPointGenerator）**:
```
src/slidemaker/pptx/generator.pyを実装してください。

要件:
1. PowerPointGeneratorクラスの実装
2. Presentationオブジェクトのラッパー
3. スライドサイズ設定（4:3、16:9、16:10）
4. ページ定義のループ処理
5. ファイル保存処理
6. 型ヒント、docstring（Google形式）を含める
7. Codexでコードレビューを実施

参考:
- Phase 1のデータモデル（SlideConfig、PageDefinition）
- researcher エージェントの調査結果
- コーディング規約（PEP 8、mypy strict mode）
```

### 3. qa エージェント（テストフェーズ）

**タスク**: ユニットテスト・統合テストの実装とCodexレビュー

**実行タイミング**: 各モジュールの実装完了後

**並列実行可能性**:
- ✅ **並列実行推奨**: 各モジュールのテストは独立

**指示内容（例: test_generator.py）**:
```
tests/pptx/test_generator.pyを実装してください。

要件:
1. PowerPointGeneratorのユニットテスト
2. カバレッジ80%以上達成
3. pytest + pytest-asyncio使用
4. tmp_pathフィクスチャでファイルI/O
5. モックの活用（SlideBuilderなど）
6. Codexでテストコードレビューを実施

参考:
- PowerPointGeneratorの実装
- Phase 1のテストコード（tests/core/、tests/llm/）
```

---

## 並列実行可能なタスク

### 実装フェーズ

以下のタスクは**並列実行可能**（対象ファイルが独立）：

1. **corder**: `src/slidemaker/pptx/generator.py`の実装
2. **corder**: `src/slidemaker/pptx/slide_builder.py`の実装
3. **corder**: `src/slidemaker/pptx/renderers/text_renderer.py`の実装
4. **corder**: `src/slidemaker/pptx/renderers/image_renderer.py`の実装
5. **corder**: `src/slidemaker/pptx/style_applier.py`の実装

**条件**:
- researcher エージェントの調査完了後
- 各ファイルが完全に独立
- メモリ使用量は中程度（2〜3並列推奨）

### テストフェーズ

以下のタスクは**並列実行可能**：

1. **qa**: `tests/pptx/test_generator.py`の実装
2. **qa**: `tests/pptx/test_slide_builder.py`の実装
3. **qa**: `tests/pptx/test_renderers.py`の実装

**条件**:
- 対応する実装が完了済み
- テストファイルが独立

### 逐次実行が必要なタスク

以下は**依存関係があるため逐次実行**：

1. researcher エージェント（python-pptx調査） → 実装フェーズ
2. 実装フェーズ → テストフェーズ
3. テストフェーズ → 統合テスト（test_full_generation.py）

---

## 次のステップ

1. **researcher エージェントの起動** → python-pptx公式ドキュメント調査
2. 調査結果をもとに実装方針の最終確認
3. **corder エージェントを並列起動**（2〜3タスク同時）→ モジュール実装
4. **qa エージェントを並列起動** → ユニットテスト実装
5. 統合テスト実施
6. カバレッジ確認（目標80%以上）
7. サンプルPowerPoint生成の動作確認
8. ドキュメント更新（README、CLAUDE.md）

---

## 参考リンク

- [python-pptx公式ドキュメント](https://python-pptx.readthedocs.io/)
- [Phase 1実装サマリー](../docs/phase1_summary.md)
- [実装ロードマップ](PLAN01/06_implementation_roadmap.md)
- [アーキテクチャ設計](PLAN01/01_architecture.md)
- [モジュール構成](PLAN01/02_module_structure.md)

---

**最終更新**: 2025-12-21
**ステータス**: 計画中（Phase 1完了済み）
**次のアクション**: researcher エージェント起動 → python-pptx調査
