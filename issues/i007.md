# Phase 6: WebUIとデプロイメント実装計画

**作成日**: 2025-12-23
**対象フェーズ**: Phase 6
**推定工数**: 4-6週
**実装規模**: 大規模（約2000-3000行、Python + TypeScript）

---

## 📋 概要

Phase 6では、Webインターフェースの実装とAWSへのデプロイを完成させます。FastAPI バックエンド、React + TypeScript フロントエンド、AWS CDKインフラ定義、CI/CDパイプラインを含みます。

### 主要実装内容

1. **FastAPI バックエンドAPI**: RESTful API、ファイルアップロード、非同期ジョブキュー
2. **React + TypeScript フロントエンド**: Vite + React 18、Tailwind CSS、ファイルアップロード機能
3. **AWS CDKインフラ定義**: Lambda、API Gateway、S3、CloudFront、Secrets Manager
4. **CI/CDパイプライン**: GitHub Actions、自動デプロイ
5. **PyPI公開**: パッケージング、リリースノート

---

## 🎯 実装ファイル一覧

### 1. FastAPI バックエンドAPI

#### 1.1 メインエントリーポイント
**ファイル**: `src/slidemaker/api/main.py`

```python
from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import FileResponse
from typing import List, Optional
from pathlib import Path
import uuid

app = FastAPI(
    title="Slidemaker API",
    version="0.1.0",
    description="AI-powered PowerPoint generator API"
)

# CORS設定
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 本番では制限
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
async def root():
    """ヘルスチェック"""
    return {"message": "Slidemaker API", "status": "healthy"}

@app.post("/api/v1/slides/create")
async def create_slides(
    markdown: UploadFile = File(...),
    theme: Optional[str] = None
):
    """Markdownからスライド作成"""
    # タスクIDの生成
    # ファイル保存（S3またはローカル）
    # NewSlideWorkflowの非同期実行
    # タスクIDを返す

@app.post("/api/v1/slides/convert")
async def convert_slides(
    files: List[UploadFile] = File(...)
):
    """PDF/画像からスライド変換"""
    # タスクIDの生成
    # ファイル保存
    # ConversionWorkflowの非同期実行
    # タスクIDを返す

@app.get("/api/v1/slides/{task_id}/status")
async def get_task_status(task_id: str):
    """タスクステータスの取得"""
    # DynamoDB or S3からステータス取得
    # 進捗率、ステータス、エラーメッセージを返す

@app.get("/api/v1/slides/{task_id}/download")
async def download_result(task_id: str):
    """生成されたスライドのダウンロード"""
    # S3から生成ファイルを取得
    # FileResponseで返す

# Lambda用ハンドラ（mangum使用）
from mangum import Mangum
handler = Mangum(app)
```

**実装内容**:
- FastAPIアプリケーション初期化
- CORS設定（開発/本番環境で切り替え）
- ファイルアップロード処理（50MB制限）
- 非同期タスク処理（後述のTaskManager使用）
- ダウンロードエンドポイント
- Lambda用ハンドラ（mangum）
- エラーハンドリング

**依存関係**: FastAPI, mangum, Phase 3 (NewSlideWorkflow), Phase 4 (ConversionWorkflow)

---

#### 1.2 APIモデル定義
**ファイル**: `src/slidemaker/api/schemas/requests.py`, `responses.py`

**requests.py**:
```python
from pydantic import BaseModel, Field
from typing import Optional, Dict, Any

class CreateRequest(BaseModel):
    """スライド作成リクエスト"""
    theme: Optional[str] = None
    options: Dict[str, Any] = Field(default_factory=dict)

class ConvertRequest(BaseModel):
    """スライド変換リクエスト"""
    analyze_only: bool = False
    options: Dict[str, Any] = Field(default_factory=dict)
```

**responses.py**:
```python
from pydantic import BaseModel
from typing import Optional
from enum import Enum

class TaskStatus(str, Enum):
    """タスクステータス"""
    PENDING = "pending"
    PROCESSING = "processing"
    COMPLETED = "completed"
    FAILED = "failed"

class TaskResponse(BaseModel):
    """タスクレスポンス"""
    task_id: str
    status: TaskStatus
    progress: int = Field(ge=0, le=100)
    result_url: Optional[str] = None
    error_message: Optional[str] = None

class HealthResponse(BaseModel):
    """ヘルスチェックレスポンス"""
    message: str
    status: str
    version: str
```

**実装内容**:
- Pydanticモデルによるリクエスト/レスポンス定義
- バリデーション（Field制約）
- Enum型でステータス管理

**依存関係**: Pydantic

---

#### 1.3 タスク管理
**ファイル**: `src/slidemaker/api/tasks.py`

```python
from typing import Any, Dict
import uuid
import asyncio
from pathlib import Path
from slidemaker.workflows.new_slide import NewSlideWorkflow
from slidemaker.workflows.conversion import ConversionWorkflow
from slidemaker.api.storage import S3Storage
from slidemaker.api.schemas.responses import TaskStatus

class TaskManager:
    """非同期タスクの管理"""

    def __init__(self, storage: S3Storage):
        self.storage = storage

    async def create_task(
        self,
        workflow_type: str,
        input_files: list[Path],
        options: dict[str, Any]
    ) -> str:
        """タスクの作成"""
        task_id = str(uuid.uuid4())

        # タスクステータスをS3に保存
        await self.storage.save_task_status(task_id, {
            "status": TaskStatus.PENDING,
            "progress": 0
        })

        # バックグラウンドタスクとして実行
        asyncio.create_task(self._execute_workflow(task_id, workflow_type, input_files, options))

        return task_id

    async def _execute_workflow(
        self,
        task_id: str,
        workflow_type: str,
        input_files: list[Path],
        options: dict[str, Any]
    ):
        """ワークフローの実行"""
        try:
            # ステータス更新: PROCESSING
            await self.storage.save_task_status(task_id, {
                "status": TaskStatus.PROCESSING,
                "progress": 10
            })

            if workflow_type == "create":
                workflow = NewSlideWorkflow(...)
                result = await workflow.execute(input_files[0], options)
            elif workflow_type == "convert":
                workflow = ConversionWorkflow(...)
                result = await workflow.execute(input_files, options)

            # 結果をS3に保存
            result_url = await self.storage.save_result(task_id, result)

            # ステータス更新: COMPLETED
            await self.storage.save_task_status(task_id, {
                "status": TaskStatus.COMPLETED,
                "progress": 100,
                "result_url": result_url
            })

        except Exception as e:
            # エラー時ステータス更新
            await self.storage.save_task_status(task_id, {
                "status": TaskStatus.FAILED,
                "progress": 0,
                "error_message": str(e)
            })

    async def get_task_status(self, task_id: str) -> Dict[str, Any]:
        """タスクステータスの取得"""
        return await self.storage.get_task_status(task_id)
```

**実装内容**:
- UUID生成
- 非同期タスク実行（asyncio.create_task）
- ステータス管理（PENDING → PROCESSING → COMPLETED/FAILED）
- エラーハンドリング
- 進捗率の更新

**依存関係**: Phase 3, Phase 4, storage.py

---

#### 1.4 S3ストレージ管理
**ファイル**: `src/slidemaker/api/storage.py`

```python
import boto3
from pathlib import Path
from typing import Any, Dict
import json

class S3Storage:
    """S3ストレージ管理"""

    def __init__(self, bucket_name: str):
        self.bucket_name = bucket_name
        self.s3_client = boto3.client('s3')

    async def save_task_status(self, task_id: str, status: Dict[str, Any]):
        """タスクステータスの保存"""
        key = f"tasks/{task_id}/status.json"
        self.s3_client.put_object(
            Bucket=self.bucket_name,
            Key=key,
            Body=json.dumps(status),
            ContentType="application/json"
        )

    async def get_task_status(self, task_id: str) -> Dict[str, Any]:
        """タスクステータスの取得"""
        key = f"tasks/{task_id}/status.json"
        obj = self.s3_client.get_object(Bucket=self.bucket_name, Key=key)
        return json.loads(obj['Body'].read())

    async def save_result(self, task_id: str, result_path: Path) -> str:
        """生成結果の保存"""
        key = f"results/{task_id}/{result_path.name}"
        self.s3_client.upload_file(str(result_path), self.bucket_name, key)
        # 署名付きURL生成（7日間有効）
        url = self.s3_client.generate_presigned_url(
            'get_object',
            Params={'Bucket': self.bucket_name, 'Key': key},
            ExpiresIn=7*24*3600
        )
        return url

    async def upload_file(self, task_id: str, file_path: Path) -> str:
        """アップロードファイルの保存"""
        key = f"uploads/{task_id}/{file_path.name}"
        self.s3_client.upload_file(str(file_path), self.bucket_name, key)
        return key
```

**実装内容**:
- boto3によるS3操作
- タスクステータスのJSON保存
- 生成ファイルの保存
- 署名付きURL生成（ダウンロード用）
- アップロードファイル管理

**依存関係**: boto3

---

### 2. React + TypeScript フロントエンド

#### 2.1 ディレクトリ構造

```
frontend/
├── public/
│   ├── index.html
│   └── favicon.ico
├── src/
│   ├── components/
│   │   ├── FileUpload.tsx       # ファイルアップロードコンポーネント
│   │   ├── ProgressBar.tsx      # 進捗バー
│   │   ├── ResultViewer.tsx     # 結果表示
│   │   └── ThemeSelector.tsx    # テーマ選択
│   ├── pages/
│   │   ├── HomePage.tsx         # ホームページ
│   │   ├── CreatePage.tsx       # 新規作成ページ
│   │   └── ConvertPage.tsx      # 変換ページ
│   ├── hooks/
│   │   ├── useFileUpload.ts     # ファイルアップロードフック
│   │   └── useTaskStatus.ts     # タスクステータスポーリングフック
│   ├── api/
│   │   └── client.ts            # APIクライアント
│   ├── types/
│   │   └── api.ts               # API型定義
│   ├── App.tsx                  # メインアプリケーション
│   └── main.tsx                 # エントリーポイント
├── package.json
├── vite.config.ts
├── tsconfig.json
└── tailwind.config.js
```

---

#### 2.2 コンポーネント実装例

**FileUpload.tsx**:
```typescript
import React, { useState, useCallback } from 'react';
import { useDropzone } from 'react-dropzone';

interface FileUploadProps {
  accept: string;
  maxSize?: number; // MB
  onUpload: (files: File[]) => void;
}

export const FileUpload: React.FC<FileUploadProps> = ({
  accept,
  maxSize = 50,
  onUpload
}) => {
  const [error, setError] = useState<string | null>(null);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    accept,
    maxSize: maxSize * 1024 * 1024,
    onDrop: (acceptedFiles, rejectedFiles) => {
      if (rejectedFiles.length > 0) {
        setError(`ファイルサイズは${maxSize}MB以下にしてください`);
        return;
      }
      setError(null);
      onUpload(acceptedFiles);
    }
  });

  return (
    <div className="w-full">
      <div
        {...getRootProps()}
        className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition ${
          isDragActive
            ? 'border-blue-500 bg-blue-50'
            : 'border-gray-300 hover:border-gray-400'
        }`}
      >
        <input {...getInputProps()} />
        {isDragActive ? (
          <p className="text-blue-500">ここにファイルをドロップ...</p>
        ) : (
          <div>
            <p className="text-gray-600">ファイルをドラッグ&ドロップ</p>
            <p className="text-gray-400 text-sm mt-2">または クリックして選択</p>
          </div>
        )}
      </div>
      {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
    </div>
  );
};
```

**ProgressBar.tsx**:
```typescript
import React, { useEffect, useState } from 'react';

interface ProgressBarProps {
  taskId: string;
  onComplete: (resultUrl: string) => void;
  onError: (error: string) => void;
}

export const ProgressBar: React.FC<ProgressBarProps> = ({
  taskId,
  onComplete,
  onError
}) => {
  const [progress, setProgress] = useState(0);
  const [status, setStatus] = useState<string>('pending');

  useEffect(() => {
    const interval = setInterval(async () => {
      try {
        const response = await fetch(`/api/v1/slides/${taskId}/status`);
        const data = await response.json();

        setProgress(data.progress);
        setStatus(data.status);

        if (data.status === 'completed') {
          clearInterval(interval);
          onComplete(data.result_url);
        } else if (data.status === 'failed') {
          clearInterval(interval);
          onError(data.error_message);
        }
      } catch (e) {
        clearInterval(interval);
        onError('ステータス取得エラー');
      }
    }, 2000); // 2秒ごとにポーリング

    return () => clearInterval(interval);
  }, [taskId, onComplete, onError]);

  return (
    <div className="w-full">
      <div className="w-full bg-gray-200 rounded-full h-4 mb-2">
        <div
          className="bg-blue-500 h-4 rounded-full transition-all duration-500"
          style={{ width: `${progress}%` }}
        />
      </div>
      <p className="text-sm text-gray-600">{status} - {progress}%</p>
    </div>
  );
};
```

**APIクライアント (api/client.ts)**:
```typescript
import axios from 'axios';

const API_BASE = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000';

const apiClient = axios.create({
  baseURL: API_BASE,
  timeout: 300000, // 5分
  headers: {
    'Content-Type': 'multipart/form-data'
  }
});

export const createSlides = async (markdown: File, theme?: string) => {
  const formData = new FormData();
  formData.append('markdown', markdown);
  if (theme) formData.append('theme', theme);

  const response = await apiClient.post('/api/v1/slides/create', formData);
  return response.data;
};

export const convertSlides = async (files: File[]) => {
  const formData = new FormData();
  files.forEach(file => formData.append('files', file));

  const response = await apiClient.post('/api/v1/slides/convert', formData);
  return response.data;
};

export const getTaskStatus = async (taskId: string) => {
  const response = await apiClient.get(`/api/v1/slides/${taskId}/status`);
  return response.data;
};

export const downloadResult = (taskId: string) => {
  return `${API_BASE}/api/v1/slides/${taskId}/download`;
};
```

**実装内容**:
- React 18 + TypeScript
- Vite（高速ビルド）
- Tailwind CSS（スタイリング）
- react-dropzone（ファイルドラッグ&ドロップ）
- axios（HTTP通信）
- ポーリング（2秒間隔でステータス確認）
- レスポンシブデザイン

**依存関係**: React, TypeScript, Vite, Tailwind CSS, axios, react-dropzone

---

### 3. AWS CDKインフラ定義

#### 3.1 CDKディレクトリ構造

```
infrastructure/
├── bin/
│   └── app.py              # CDKアプリエントリーポイント
├── stacks/
│   ├── storage_stack.py    # S3, DynamoDB
│   ├── lambda_stack.py     # Lambda関数
│   ├── api_gateway_stack.py # API Gateway
│   └── frontend_stack.py   # CloudFront + S3
├── requirements.txt
└── cdk.json
```

---

#### 3.2 ストレージスタック
**ファイル**: `infrastructure/stacks/storage_stack.py`

```python
from aws_cdk import (
    Stack,
    aws_s3 as s3,
    Duration,
    RemovalPolicy,
)
from constructs import Construct

class StorageStack(Stack):
    def __init__(self, scope: Construct, id: str, **kwargs):
        super().__init__(scope, id, **kwargs)

        # S3バケット（生成ファイル保存用）
        self.storage_bucket = s3.Bucket(
            self, "StorageBucket",
            bucket_name="slidemaker-storage-prod",
            cors=[s3.CorsRule(
                allowed_methods=[s3.HttpMethods.GET, s3.HttpMethods.PUT, s3.HttpMethods.POST],
                allowed_origins=["*"],  # 本番では制限
                allowed_headers=["*"]
            )],
            lifecycle_rules=[
                s3.LifecycleRule(
                    id="DeleteOldFiles",
                    expiration=Duration.days(7),  # 7日後に自動削除
                    enabled=True
                )
            ],
            encryption=s3.BucketEncryption.S3_MANAGED,
            versioned=True,
            removal_policy=RemovalPolicy.DESTROY
        )
```

---

#### 3.3 Lambdaスタック
**ファイル**: `infrastructure/stacks/lambda_stack.py`

```python
from aws_cdk import (
    Stack,
    aws_lambda as lambda_,
    aws_secretsmanager as secretsmanager,
    Duration,
)
from constructs import Construct

class LambdaStack(Stack):
    def __init__(self, scope: Construct, id: str, storage_bucket, **kwargs):
        super().__init__(scope, id, **kwargs)

        # Secrets Manager から API キーを取得
        llm_secrets = secretsmanager.Secret.from_secret_name_v2(
            self, "LLMSecrets",
            secret_name="slidemaker/llm-api-keys"
        )

        # Lambda関数
        self.handler = lambda_.Function(
            self, "Handler",
            function_name="slidemaker-api-prod",
            runtime=lambda_.Runtime.PYTHON_3_13,
            code=lambda_.Code.from_asset("../dist"),  # ビルド済みパッケージ
            handler="slidemaker.api.main.handler",
            memory_size=3008,  # 最大メモリ（3GB）
            timeout=Duration.minutes(15),  # 最大タイムアウト
            environment={
                "STORAGE_BUCKET": storage_bucket.bucket_name,
                "LLM_SECRETS_ARN": llm_secrets.secret_arn,
                "LOG_LEVEL": "INFO"
            }
        )

        # S3バケットへの読み書き権限
        storage_bucket.grant_read_write(self.handler)

        # Secrets Manager 読み取り権限
        llm_secrets.grant_read(self.handler)
```

---

#### 3.4 API Gatewayスタック
**ファイル**: `infrastructure/stacks/api_gateway_stack.py`

```python
from aws_cdk import (
    Stack,
    aws_apigatewayv2 as apigw,
    aws_apigatewayv2_integrations as integrations,
)
from constructs import Construct

class ApiGatewayStack(Stack):
    def __init__(self, scope: Construct, id: str, lambda_function, **kwargs):
        super().__init__(scope, id, **kwargs)

        # HTTP API
        self.http_api = apigw.HttpApi(
            self, "HttpApi",
            api_name="slidemaker-api-prod",
            cors_preflight=apigw.CorsPreflightOptions(
                allow_origins=["*"],  # 本番では制限
                allow_methods=[apigw.CorsHttpMethod.ANY],
                allow_headers=["*"],
                max_age=Duration.hours(1)
            )
        )

        # Lambda統合
        integration = integrations.HttpLambdaIntegration(
            "LambdaIntegration",
            lambda_function
        )

        # ルート追加
        self.http_api.add_routes(
            path="/{proxy+}",
            methods=[apigw.HttpMethod.ANY],
            integration=integration
        )
```

---

#### 3.5 フロントエンドスタック
**ファイル**: `infrastructure/stacks/frontend_stack.py`

```python
from aws_cdk import (
    Stack,
    aws_s3 as s3,
    aws_cloudfront as cloudfront,
    aws_cloudfront_origins as origins,
    RemovalPolicy,
)
from constructs import Construct

class FrontendStack(Stack):
    def __init__(self, scope: Construct, id: str, **kwargs):
        super().__init__(scope, id, **kwargs)

        # フロントエンド用S3バケット
        self.frontend_bucket = s3.Bucket(
            self, "FrontendBucket",
            bucket_name="slidemaker-frontend-prod",
            public_read_access=False,  # CloudFront経由のみアクセス
            removal_policy=RemovalPolicy.DESTROY,
            auto_delete_objects=True
        )

        # CloudFront Distribution
        self.distribution = cloudfront.Distribution(
            self, "Distribution",
            default_behavior=cloudfront.BehaviorOptions(
                origin=origins.S3Origin(self.frontend_bucket),
                viewer_protocol_policy=cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                cache_policy=cloudfront.CachePolicy.CACHING_OPTIMIZED
            ),
            default_root_object="index.html",
            error_responses=[
                cloudfront.ErrorResponse(
                    http_status=404,
                    response_http_status=200,
                    response_page_path="/index.html"  # SPA対応
                )
            ]
        )
```

---

### 4. CI/CDパイプライン

#### 4.1 API デプロイ
**ファイル**: `.github/workflows/deploy-api.yml`

```yaml
name: Deploy API

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'infrastructure/**'
    tags: ['v*']

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Build package
        run: |
          uv sync
          uv build
          mkdir -p dist
          cp -r src/slidemaker dist/
          pip install -r requirements.txt -t dist/

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to AWS Lambda
        run: |
          cd infrastructure
          pip install -r requirements.txt
          cdk deploy --all --require-approval never
```

---

#### 4.2 フロントエンド デプロイ
**ファイル**: `.github/workflows/deploy-frontend.yml`

```yaml
name: Deploy Frontend

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ secrets.API_URL }}
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/dist s3://slidemaker-frontend-prod/ --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
```

---

#### 4.3 PyPI公開
**ファイル**: `.github/workflows/publish-pypi.yml`

```yaml
name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install build tools
        run: uv pip install --system build twine

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
```

---

## 📅 実装スケジュール

### Week 1: FastAPI バックエンドAPI（5-7日）

#### Day 1-2: 基本APIエンドポイント
- [ ] `main.py`の実装（FastAPIアプリ、CORS、ヘルスチェック）
- [ ] `schemas/requests.py`, `responses.py`の実装
- [ ] `/api/v1/slides/create`エンドポイント（基本部分）
- [ ] `/api/v1/slides/convert`エンドポイント（基本部分）

**並列実行可能**: `requests.py`と`responses.py`は同時実行可能

#### Day 3-4: タスク管理とストレージ
- [ ] `tasks.py`の実装（TaskManager、非同期タスク実行）
- [ ] `storage.py`の実装（S3Storage、ステータス管理）
- [ ] `/api/v1/slides/{task_id}/status`エンドポイント
- [ ] `/api/v1/slides/{task_id}/download`エンドポイント

**並列実行可能**: `tasks.py`と`storage.py`は並行開発可能（インターフェース定義後）

#### Day 5-7: 統合とテスト
- [ ] ワークフロー統合（NewSlideWorkflow、ConversionWorkflow呼び出し）
- [ ] エラーハンドリング強化
- [ ] Lambda用ハンドラ（mangum）設定
- [ ] ローカルテスト（uvicorn）

---

### Week 2: React フロントエンド（5-7日）

#### Day 1-2: プロジェクトセットアップとコアコンポーネント
- [ ] Vite + React + TypeScript プロジェクト初期化
- [ ] Tailwind CSS設定
- [ ] `api/client.ts`の実装（APIクライアント）
- [ ] `types/api.ts`の実装（型定義）
- [ ] `components/FileUpload.tsx`の実装

**並列実行可能**: `api/client.ts`と`types/api.ts`は同時実装可能

#### Day 3-4: UIコンポーネント
- [ ] `components/ProgressBar.tsx`の実装
- [ ] `components/ResultViewer.tsx`の実装
- [ ] `components/ThemeSelector.tsx`の実装
- [ ] `hooks/useFileUpload.ts`の実装
- [ ] `hooks/useTaskStatus.ts`の実装

**並列実行可能**: すべてのコンポーネントは独立（3-4並列推奨）

#### Day 5-7: ページと統合
- [ ] `pages/HomePage.tsx`の実装
- [ ] `pages/CreatePage.tsx`の実装
- [ ] `pages/ConvertPage.tsx`の実装
- [ ] `App.tsx`の実装（ルーティング）
- [ ] レスポンシブデザイン調整

---

### Week 3: AWS CDKインフラ定義（4-5日）

#### Day 1-2: CDKプロジェクトとストレージ
- [ ] CDKプロジェクト初期化（`bin/app.py`, `cdk.json`）
- [ ] `stacks/storage_stack.py`の実装（S3バケット、ライフサイクルポリシー）
- [ ] `stacks/lambda_stack.py`の実装（Lambda関数、環境変数、権限）

**並列実行可能**: `storage_stack.py`と`lambda_stack.py`のドラフト作成は並行可能

#### Day 3-4: API GatewayとフロントエンドCDK
- [ ] `stacks/api_gateway_stack.py`の実装（HTTP API、CORS、Lambda統合）
- [ ] `stacks/frontend_stack.py`の実装（CloudFront、S3）
- [ ] CDK統合テスト（`cdk synth`）

**並列実行可能**: `api_gateway_stack.py`と`frontend_stack.py`は独立

#### Day 5: デプロイテストとSecrets Manager
- [ ] Secrets Manager設定（LLM APIキー）
- [ ] ステージング環境へのデプロイ
- [ ] 動作確認

---

### Week 4: CI/CDパイプラインとテスト（5-7日）

#### Day 1-2: GitHub Actions設定
- [ ] `.github/workflows/deploy-api.yml`の実装
- [ ] `.github/workflows/deploy-frontend.yml`の実装
- [ ] `.github/workflows/publish-pypi.yml`の実装
- [ ] GitHub Secrets設定

**並列実行可能**: 3つのワークフローファイルは独立（3並列推奨）

#### Day 3-4: バックエンドテスト
- [ ] `tests/api/test_main.py`（APIエンドポイント）
- [ ] `tests/api/test_tasks.py`（タスク管理）
- [ ] `tests/api/test_storage.py`（S3ストレージ）
- [ ] カバレッジ確認（目標: 80%以上）

**並列実行可能**: すべてのテストファイルは独立（3並列推奨）

#### Day 5-7: フロントエンドテストと統合テスト
- [ ] `frontend/src/__tests__/`（Vitest + React Testing Library）
- [ ] E2Eテスト（Playwright）
- [ ] 統合テスト（API + Frontend）
- [ ] パフォーマンステスト

---

### Week 5-6: 本番デプロイとドキュメント（7-10日）

#### Week 5: 本番デプロイ準備
- [ ] セキュリティレビュー（QAエージェント）
- [ ] パフォーマンス最適化
- [ ] エラーハンドリング改善
- [ ] CloudWatchアラーム設定
- [ ] コスト最適化

#### Week 6: 本番デプロイとドキュメント
- [ ] 本番環境へのデプロイ
- [ ] 動作確認とモニタリング
- [ ] ユーザーガイド作成
- [ ] API仕様書（OpenAPI/Swagger）作成
- [ ] README.md更新
- [ ] PyPI公開
- [ ] リリースノート作成

---

## 🤖 必要な専門サブエージェント

### 1. ndf:corder（バックエンド実装）

**タスク1: FastAPI基本実装（並列実行推奨）**
```
指示内容:
「Phase 6 FastAPIバックエンドAPIの基本部分を実装してください。

【並列実行グループ1】
- src/slidemaker/api/schemas/requests.py: Pydanticリクエストモデル
- src/slidemaker/api/schemas/responses.py: Pydanticレスポンスモデル

【並列実行グループ2】（Group 1完了後）
- src/slidemaker/api/main.py: FastAPIアプリ、エンドポイント基本部分
- src/slidemaker/api/tasks.py: TaskManager（非同期タスク実行）
- src/slidemaker/api/storage.py: S3Storage（ステータス/ファイル管理）

実装要件:
- PEP 8準拠、型ヒント必須（mypy strict mode）
- FastAPI + mangum（Lambda用）
- CORS設定（開発/本番切り替え可能）
- ファイルアップロード（50MB制限）
- 非同期処理（asyncio）
- Google形式docstring

参考:
- issues/i007.md: Phase 6実装計画
- issues/PLAN01/06_implementation_roadmap.md: 詳細設計
- src/slidemaker/workflows/new_slide.py: NewSlideWorkflow（Phase 3）
- src/slidemaker/workflows/conversion.py: ConversionWorkflow（Phase 4）
」
```

**タスク2: ワークフロー統合とエラーハンドリング（逐次実行）**
```
指示内容:
「Phase 6 FastAPIバックエンドのワークフロー統合とエラーハンドリングを完成させてください。

実装内容:
- NewSlideWorkflow、ConversionWorkflowの呼び出し統合
- エラーハンドリング強化（HTTPException、カスタムエラーレスポンス）
- Lambda用ハンドラ（mangum）完成
- ローカルテスト確認（uvicorn）

実装要件:
- タスクID生成（uuid）
- ステータス管理（PENDING → PROCESSING → COMPLETED/FAILED）
- 進捗率の更新
- 例外処理とログ出力

参考:
- issues/i007.md: Phase 6実装計画
- src/slidemaker/api/tasks.py: TaskManager（Task 1で実装）
」
```

---

### 2. ndf:corder（フロントエンド実装）

**タスク3: React プロジェクトセットアップとAPIクライアント（並列実行推奨）**
```
指示内容:
「Phase 6 React + TypeScript フロントエンドのプロジェクトセットアップとAPIクライアントを実装してください。

【並列実行グループ3】
- frontend/: Vite + React + TypeScript プロジェクト初期化、Tailwind CSS設定
- frontend/src/api/client.ts: axiosベースのAPIクライアント
- frontend/src/types/api.ts: TypeScript型定義（リクエスト/レスポンス）

実装要件:
- Vite（vite.config.ts設定）
- React 18 + TypeScript
- Tailwind CSS（tailwind.config.js）
- axios（HTTP通信）
- 環境変数（VITE_API_BASE_URL）

参考:
- issues/i007.md: Phase 6実装計画
- issues/PLAN01/06_implementation_roadmap.md: フロントエンド設計
」
```

**タスク4: Reactコンポーネント実装（並列実行推奨）**
```
指示内容:
「Phase 6 React + TypeScript フロントエンドのコンポーネントを実装してください。

【並列実行グループ4】（4並列推奨）
- frontend/src/components/FileUpload.tsx: ファイルアップロード（react-dropzone）
- frontend/src/components/ProgressBar.tsx: 進捗バー（ポーリング）
- frontend/src/components/ResultViewer.tsx: 結果表示
- frontend/src/hooks/useFileUpload.ts: ファイルアップロードフック
- frontend/src/hooks/useTaskStatus.ts: タスクステータスフック

実装要件:
- Tailwind CSSスタイリング
- react-dropzone（ドラッグ&ドロップ）
- ポーリング（2秒間隔）
- エラーハンドリング
- レスポンシブデザイン

参考:
- issues/i007.md: コンポーネント実装例
- frontend/src/api/client.ts: APIクライアント（Task 3で実装）
」
```

**タスク5: Reactページとルーティング（逐次実行）**
```
指示内容:
「Phase 6 React + TypeScript フロントエンドのページとルーティングを完成させてください。

実装ファイル:
- frontend/src/pages/HomePage.tsx: ホームページ
- frontend/src/pages/CreatePage.tsx: 新規作成ページ
- frontend/src/pages/ConvertPage.tsx: 変換ページ
- frontend/src/App.tsx: メインアプリケーション（React Router）

実装要件:
- React Router v6
- レスポンシブデザイン
- ローディング状態管理
- エラー表示

参考:
- issues/i007.md: Phase 6実装計画
- frontend/src/components/: コンポーネント（Task 4で実装）
」
```

---

### 3. ndf:corder（インフラ実装）

**タスク6: AWS CDK実装（並列実行推奨）**
```
指示内容:
「Phase 6 AWS CDKインフラ定義を実装してください。

【並列実行グループ5】（2並列推奨）
- infrastructure/stacks/storage_stack.py: S3バケット、ライフサイクルポリシー
- infrastructure/stacks/lambda_stack.py: Lambda関数、環境変数、権限

【並列実行グループ6】（2並列推奨、Group 5完了後）
- infrastructure/stacks/api_gateway_stack.py: HTTP API、CORS、Lambda統合
- infrastructure/stacks/frontend_stack.py: CloudFront、S3

実装ファイル:
- infrastructure/bin/app.py: CDKアプリエントリーポイント
- infrastructure/cdk.json: CDK設定
- infrastructure/requirements.txt: CDK依存関係

実装要件:
- aws-cdk-lib 2.100.0以上
- Python 3.13
- S3暗号化（SSE-S3）
- Lambda メモリ3GB、タイムアウト15分
- CloudFront（SPA対応、エラーレスポンス設定）
- Secrets Manager統合

参考:
- issues/i007.md: Phase 6実装計画
- issues/PLAN01/05_deployment.md: デプロイ戦略
」
```

---

### 4. ndf:qa（品質保証）

**タスク: コード品質・セキュリティレビュー（逐次実行）**
```
指示内容:
「Phase 6実装のコード品質・セキュリティレビューを実施してください。

レビュー対象:
1. バックエンド:
   - src/slidemaker/api/main.py
   - src/slidemaker/api/tasks.py
   - src/slidemaker/api/storage.py
   - src/slidemaker/api/schemas/

2. フロントエンド:
   - frontend/src/api/client.ts
   - frontend/src/components/
   - frontend/src/pages/

3. インフラ:
   - infrastructure/stacks/

チェック項目:
1. コード品質:
   - 可読性、保守性
   - 型ヒント完全性（Python mypy、TypeScript strict）
   - docstring/コメント完備

2. セキュリティ（OWASP Top 10準拠）:
   - CORS設定（本番環境での制限）
   - ファイルアップロードサイズ制限（50MB）
   - パストラバーサル対策（S3キー生成）
   - Secrets Manager活用（APIキー管理）
   - HTTPS必須（CloudFront、API Gateway）
   - 認証・認可（オプション：JWT）

3. ベストプラクティス:
   - FastAPI使用法
   - React + TypeScript パターン
   - AWS CDK推奨設定
   - エラーハンドリング

Codexでセキュリティスキャンを実施してください。
改善提案があれば具体的なコード例を提示してください。
」
```

---

### 5. ndf:corder（テスト実装）

**タスク7: バックエンドテスト（並列実行推奨）**
```
指示内容:
「Phase 6 FastAPIバックエンドのテストを実装してください。

【並列実行グループ7】（3並列推奨）
- tests/api/test_main.py: APIエンドポイントのテスト
- tests/api/test_tasks.py: TaskManagerのテスト
- tests/api/test_storage.py: S3Storageのテスト

テスト要件:
- pytestフレームワーク
- FastAPIテストクライアント（TestClient）
- モック（boto3、ワークフロー）
- カバレッジ80%以上
- 正常系・異常系

参考:
- issues/i007.md: Phase 6実装計画
- tests/workflows/test_new_slide.py: 既存テスト例
」
```

**タスク8: フロントエンドテスト（並列実行推奨）**
```
指示内容:
「Phase 6 React フロントエンドのテストを実装してください。

実装内容:
- frontend/src/__tests__/: Vitest + React Testing Library
- E2Eテスト: Playwright（オプション）

テスト対象:
- コンポーネント（FileUpload, ProgressBar, ResultViewer）
- API クライアント（モック）
- ページ（HomePage, CreatePage, ConvertPage）

テスト要件:
- Vitest（vite-test.config.ts設定）
- React Testing Library
- MSW（APIモック）
- カバレッジ80%以上

参考:
- issues/i007.md: Phase 6実装計画
- frontend/src/components/: 実装済みコンポーネント
」
```

---

### 6. ndf:researcher（ドキュメント作成）

**タスク: ユーザーガイドとAPI仕様書作成（逐次実行）**
```
指示内容:
「Phase 6のユーザーガイドとAPI仕様書を作成してください。

作成内容:
1. docs/user_guide.md:
   - WebUI使用方法
   - CLI使用方法
   - トラブルシューティング

2. docs/api_specification.md:
   - OpenAPI/Swagger形式
   - エンドポイント一覧
   - リクエスト/レスポンス例
   - エラーコード一覧

3. README.md更新:
   - WebUI デモURL
   - インストール方法（PyPI）
   - クイックスタート

参考:
- issues/i007.md: Phase 6実装計画
- src/slidemaker/api/main.py: 実装済みAPI
- frontend/src/: フロントエンド実装
」
```

---

## ⚡ 並列実行推奨タスク

### 【並列実行グループ1】: Pydanticスキーマ（Week 1 Day 1）
- `requests.py`と`responses.py`
- **理由**: 完全に独立、相互依存なし

### 【並列実行グループ2】: バックエンドコア（Week 1 Day 3-4）
- `tasks.py`と`storage.py`
- **理由**: インターフェース定義後は並行開発可能

### 【並列実行グループ3】: Reactセットアップ（Week 2 Day 1-2）
- プロジェクト初期化、`api/client.ts`、`types/api.ts`
- **理由**: 独立したセットアップタスク

### 【並列実行グループ4】: Reactコンポーネント（Week 2 Day 3-4）
- `FileUpload.tsx`, `ProgressBar.tsx`, `ResultViewer.tsx`, `useFileUpload.ts`, `useTaskStatus.ts`
- **推奨並列数**: 4-5並列
- **理由**: すべてのコンポーネントが独立

### 【並列実行グループ5】: CDKストレージとLambda（Week 3 Day 1-2）
- `storage_stack.py`と`lambda_stack.py`
- **理由**: インターフェース定義後は並行開発可能

### 【並列実行グループ6】: CDK API GatewayとFrontend（Week 3 Day 3-4）
- `api_gateway_stack.py`と`frontend_stack.py`
- **理由**: 独立したスタック

### 【並列実行グループ7】: バックエンドテスト（Week 4 Day 3-4）
- `test_main.py`, `test_tasks.py`, `test_storage.py`
- **推奨並列数**: 3並列
- **理由**: すべてのテストファイルが独立

---

## 逐次実行が必要なタスク

1. **ワークフロー統合**: バックエンドコア（Group 2）完了後
2. **Reactページ**: コンポーネント（Group 4）完了後
3. **CDKデプロイテスト**: すべてのスタック（Group 5, 6）完了後
4. **E2Eテスト**: バックエンド・フロントエンド両方完成後
5. **QAレビュー**: すべてのコード実装完了後
6. **ドキュメント作成**: 実装・テスト完了後

---

## 🔒 セキュリティ要件

### 1. CORS設定
- **本番環境**: 特定のオリジンのみ許可
- **開発環境**: `*`（すべて許可）

### 2. ファイルアップロード
- **サイズ制限**: 50MB
- **ファイル種別チェック**: Markdown, PDF, 画像のみ
- **S3キーパストラバーサル対策**: uuid生成

### 3. Secrets Manager
- **APIキー管理**: ANTHROPIC_API_KEY, OPENAI_API_KEY, GOOGLE_API_KEY
- **IAMロールベースアクセス**: Lambda関数のみ読み取り可能

### 4. HTTPS必須
- **CloudFront**: `REDIRECT_TO_HTTPS`
- **API Gateway**: HTTPSエンドポイントのみ

### 5. S3セキュリティ
- **暗号化**: SSE-S3（サーバーサイド暗号化）
- **公開アクセス**: 無効（CloudFront経由のみ）
- **署名付きURL**: 7日間有効

---

## 📊 テスト要件

### カバレッジ目標
- **バックエンドユニットテスト**: 80%以上
- **フロントエンドユニットテスト**: 80%以上
- **E2Eテスト**: 主要ユースケース100%

### テスト構成

**バックエンド**:
```
tests/api/
├── test_main.py              # APIエンドポイント
├── test_tasks.py             # タスク管理
├── test_storage.py           # S3ストレージ
└── integration/
    └── test_api_workflow.py  # 統合テスト
```

**フロントエンド**:
```
frontend/src/__tests__/
├── components/
│   ├── FileUpload.test.tsx
│   ├── ProgressBar.test.tsx
│   └── ResultViewer.test.tsx
├── api/
│   └── client.test.ts
└── pages/
    ├── HomePage.test.tsx
    ├── CreatePage.test.tsx
    └── ConvertPage.test.tsx
```

---

## 🌐 環境構成

### 開発環境
- **API**: localhost:8000（uvicorn）
- **WebUI**: localhost:5173（Vite dev server）
- **LLM**: モック使用

### ステージング環境
- **API**: https://staging-api.slidemaker.example.com
- **WebUI**: https://staging.slidemaker.example.com
- **LLM**: 実際のAPI（低コストモデル）

### 本番環境
- **API**: https://api.slidemaker.example.com
- **WebUI**: https://slidemaker.example.com
- **LLM**: 実際のAPI（高性能モデル）

---

## 💰 コスト見積もり（月間1000リクエスト想定）

| サービス | 使用量 | コスト |
|---------|--------|--------|
| Lambda | 1000実行 × 3GB × 30秒 | $0.50 |
| API Gateway | 1000リクエスト | $0.01 |
| S3（保存） | 10GB | $0.23 |
| S3（転送） | 100GB | $9.00 |
| CloudFront | 100GB転送 | $8.50 |
| CloudWatch | ログ保存 | $0.50 |
| **合計** | | **約$18.74/月** |

---

## 📚 参考リンク

### 実装済みモジュール
- **Phase 3**: `src/slidemaker/workflows/new_slide.py` (NewSlideWorkflow)
- **Phase 4**: `src/slidemaker/workflows/conversion.py` (ConversionWorkflow)
- **Phase 5**: `src/slidemaker/cli/` (CLI実装)

### ドキュメント
- **ロードマップ**: `issues/PLAN01/06_implementation_roadmap.md`
- **デプロイ戦略**: `issues/PLAN01/05_deployment.md`
- **pyproject.toml**: パッケージ設定

### 外部ライブラリ
- **FastAPI**: https://fastapi.tiangolo.com/
- **React**: https://react.dev/
- **Vite**: https://vitejs.dev/
- **Tailwind CSS**: https://tailwindcss.com/
- **AWS CDK**: https://docs.aws.amazon.com/cdk/
- **mangum**: https://mangum.io/

---

## ⚠️ 技術的課題とリスク

### 課題1: Lambda 50MB制限
**問題**: FastAPIアプリ + 依存関係が50MBを超える可能性
**対策**:
- Lambda Layerで依存関係を分離
- 不要なパッケージを除外（開発用パッケージ等）
- ECRコンテナイメージ使用（10GB制限、オプション）

**対応Week**: Week 3

---

### 課題2: Lambda タイムアウト
**問題**: LLM処理が長時間（最大15分制限）
**対策**:
- 非同期タスク処理（TaskManager）
- ステータスポーリング（フロントエンド）
- Step Functionsの導入（オプション）

**対応Week**: Week 1

---

### 課題3: 非同期ジョブキュー
**問題**: Lambda内でのバックグラウンドタスク制約
**対策**:
- S3ベースのステータス管理
- DynamoDB Streamsでタスクトリガー（オプション）
- SQS + 別Lambda関数（オプション）

**対応Week**: Week 1

---

### 課題4: CORS設定
**問題**: 本番環境でのCORS制限
**対策**:
- 環境変数でオリジン切り替え
- API Gateway + CloudFrontで統一ドメイン（オプション）

**対応Week**: Week 1

---

### 課題5: React SPA + CloudFront
**問題**: SPAのルーティング（404エラー）
**対策**:
- CloudFront Error Responses設定（404 → index.html）
- S3 Static Website Hosting（オプション）

**対応Week**: Week 3

---

### 課題6: セキュリティ
**問題**: APIキー漏洩リスク
**対策**:
- Secrets Manager活用
- IAMロールベースアクセス
- 定期的なローテーション

**対応Week**: Week 3

---

## 🔧 リスク対策

### リスク1: 実装遅延（高）
**影響**: スケジュール遅延、品質低下
**対策**:
- 並列実行の最大活用
- 優先度の明確化（Week 1-3 > Week 4-6）
- モック/スタブ活用

---

### リスク2: AWS料金超過（中）
**影響**: コスト増加
**対策**:
- CloudWatchアラーム設定
- S3ライフサイクルポリシー（7日自動削除）
- Lambda同時実行数制限

---

### リスク3: セキュリティ脆弱性（高）
**影響**: データ漏洩、不正アクセス
**対策**:
- QAエージェントによるレビュー（Week 5）
- Codexセキュリティスキャン
- AWS Security Hub有効化

---

### リスク4: パフォーマンス問題（中）
**影響**: レスポンス遅延、タイムアウト
**対策**:
- Lambda メモリ最大化（3GB）
- CloudFront キャッシング最適化
- 非同期処理の徹底

---

## ✅ 完了基準

1. ✅ FastAPIバックエンドAPIが実装されている
2. ✅ React + TypeScript フロントエンドが実装されている
3. ✅ AWS CDKインフラが定義されている
4. ✅ CI/CDパイプラインが動作する（GitHub Actions）
5. ✅ ステージング環境にデプロイ成功
6. ✅ 本番環境にデプロイ成功
7. ✅ ユニットテストのカバレッジが80%以上
8. ✅ E2Eテストがすべてパスする
9. ✅ QAレビューで指摘事項がすべて解決されている
10. ✅ ドキュメントが完備されている（ユーザーガイド、API仕様書、README）
11. ✅ PyPIへの公開が完了している
12. ✅ CloudWatchモニタリングが設定されている
13. ✅ セキュリティベストプラクティスが適用されている
14. ✅ パフォーマンステストで95%ile < 5秒を達成

---

## 🚀 次のステップ

Phase 6完了後:
1. **ユーザーフィードバック収集**: ベータテスト実施
2. **機能拡張**: テンプレート機能、画像生成強化
3. **パフォーマンス最適化**: キャッシング、CDN最適化
4. **ドキュメント充実**: チュートリアル、ビデオガイド
5. **コミュニティ構築**: GitHub Discussions、Discord

---

**最終更新**: 2025-12-23
**作成者**: Director Agent
**レビュー状態**: 初版
